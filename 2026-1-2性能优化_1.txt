2026-01-02 性能优化与落地审查_1

快速定位（功能 -> 关键实现位置）
- 服务端入口/装配: server/src/main.cpp, server/src/server_app.cpp
- 协议与安全通道: server/src/frame.cpp, server/src/secure_channel.cpp
- 媒体转发: server/src/media_relay.cpp, server/src/api_service.cpp
- 客户端核心: client/src/client_core.cpp, client/src/e2ee_engine.cpp
- 媒体核心: client/src/media_session.cpp, client/src/media_pipeline.cpp, client/src/media_crypto.cpp
- 媒体帧封装: shard/media_frame.h, shard/media_frame.cpp
- QML 通话入口: client/ui/quick_client.cpp, client/ui/qml/shell/CenterPane.qml
- Widgets 通话入口(本次落地): client/ui/e2ee_main_list/ChatWindow.cpp, client/ui/e2ee_main_list/MainListWindow.cpp,
  client/ui/e2ee_main_list/CallController.cpp, client/ui/e2ee_main_list/CallDialog.cpp,
  client/ui/e2ee_main_list/BackendAdapter.cpp

问题1：语音/视频落地方案与完成项（确保判定无问题）
1) Widgets 端到端通话已落地
   - 通话控制器：client/ui/e2ee_main_list/CallController.cpp（MediaSession + Opus/H264 管线 + 抖动缓冲）
   - 通话 UI：client/ui/e2ee_main_list/CallDialog.cpp（本地/远端预览 + 接受/拒绝/挂断）
   - 聊天入口联动：client/ui/e2ee_main_list/ChatWindow.cpp、MainListWindow.cpp
2) Call Invite 解析与校验
   - 前缀协议与校验：client/ui/e2ee_main_list/CallInviteUtils.h（32字节十六进制验证）
   - 历史消息改写为系统提示：client/ui/e2ee_main_list/BackendAdapter.cpp
3) 安全性保持/增强
   - 媒体加密链沿用 media_session/media_crypto（不降低安全性）
   - 对无效 callId 直接拒绝解析（提高健壮性）
4) 判定点（建议实测）
   - 语音：双端 10 分钟持续通话无崩溃、无明显卡顿
   - 视频：首帧 < 1.5s，丢包场景画面仍可恢复
   - 邀请：历史/通知/UI 不出现明文前缀

性能优化建议（按优先级，含已完成/新增/待验证）
P0（高优先级，建议尽快验证/改进）
- [新增] Widgets 轮询线程每次 tick 新建 std::thread，可能造成频繁线程创建开销。
  建议：改为常驻工作线程或 QThread/QThreadPool（client/ui/e2ee_main_list/BackendAdapter.cpp）
- [新增] Media relay 使用单全局 mutex + map，通话并发时锁竞争明显。
  建议：按 recipient/call_id 分片锁或 lock-free ring（server/src/media_relay.cpp）
- [新增] Media pipeline 频繁 new sample/临时 buffer。
  建议：引入编码/解码 buffer pool，降低帧级分配（client/src/media_pipeline.cpp）

P1（高，性能与体验提升）
- [待验证] IOCP/事件驱动配置是否默认开启，建议确认线上默认值与回退策略。
  位置：server/src/network_server.cpp, server/config.example.ini
- [新增] Media jitter_buffer 使用 multimap，建议改为固定环形队列或小顶堆减少分配。
  位置：client/src/media_jitter_buffer.cpp
- [新增] MediaSession 频繁 vector 构造/复制，建议使用 buffer_pool 或复用缓存。
  位置：client/src/media_session.cpp, shard/buffer_pool.h
- [新增] Call UI 本地预览每帧 toImage 转换，建议节流或使用硬件路径降低 CPU。
  位置：client/ui/e2ee_main_list/CallDialog.cpp

P2（中等，持续优化）
- [已完成] 协议编码 reserve / 复用缓冲，减少重复扩容
  位置：server/src/frame_router.cpp, client/src/client_core.cpp
- [已完成] 离线存储 v3 分块流式加密，降低峰值内存
  位置：server/src/offline_storage.cpp
- [已完成] KCP 参数配置化与自适应 cover traffic
  位置：client/include/client_config.h, server/include/config.h, client/src/client_core.cpp
- [新增] UI 列表/动效节流策略建议同步到 Widgets 版（避免高刷新导致掉帧）
  位置：client/ui/e2ee_main_list/*

P3（低，长期/发布期优化）
- [已完成] PGO/LTO 与基线压测
  位置：core/.github/workflows/ci.yml, tools/perf_baseline.cpp

全面审查与功能落地判别计划（不降低安全性，可增强）
A. 构建/配置验证
- 校验 server/client 配置解析、TLS/KCP/离线目录强校验
  位置：server/src/config.cpp, client/src/client_config.cpp
- 明确 iocp_enable/kcp/kt/secure_delete 等默认值与文档一致

B. 认证/会话/密钥
- OPAQUE 注册/登录、失败限速、TTL/Token 有效期
  位置：server/src/pake.cpp, server/src/session_manager.cpp
- 客户端密钥派生与 DPAPI 保护
  位置：client/src/e2ee_engine.cpp, client/src/dpapi_util.cpp

C. 消息/好友/群聊
- 好友请求/拉黑/群成员变更流程完整性
  位置：server/src/api_service.cpp, server/src/group_manager.cpp
- 客户端历史展示/回执/重试一致性
  位置：client/src/chat_history_store.cpp, client/ui/e2ee_main_list/*

D. 离线与文件
- 离线队列 TTL、加密版本兼容、secure-delete
  位置：server/src/offline_storage.cpp, server/src/api_service.cpp
- 客户端下载/预览/擦除路径
  位置：client/src/client_core.cpp, client/ui/e2ee_main_list/ChatWindow.cpp

E. Key Transparency
- STH/一致性证明获取与验证
  位置：server/src/key_transparency.cpp, client/src/client_core.cpp

F. 语音/视频
- E2EE 媒体根派生与 ratchet 验证
  位置：client/src/media_crypto.cpp, client/src/media_session.cpp
- 媒体转发限速/队列清理/并发安全
  位置：server/src/media_relay.cpp
- UI 端通话全链路：发起/接受/挂断/后台恢复
  位置：client/ui/e2ee_main_list/CallDialog.cpp, CallController.cpp

G. 安全增强建议（可选）
- Media payload 与 call invite 增加速率限制与长度审计
- Media 临时 buffer 关闭/重置时清零（降低内存残留）

H. 测试与验收
- 运行现有测试与 fuzz：server/tests/*, client/tests/*, server/fuzz/*, client/fuzz/*
- 增补通话相关单测/集成测试（邀请/接受/丢包/超时）
- 性能基线：tools/perf_baseline.cpp + ops_health_view.cpp

备注
- 以上计划不降低安全性，优先保持 E2EE 与密钥擦除策略。
- Widgets 通话落地已完成，QML 通话路径保持不变。
