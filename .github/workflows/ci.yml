name: ci

on:
  push:
    branches:
      - master
      - e2ee_dev
  workflow_dispatch:

jobs:
  build-package:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git submodule update --init --recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Qt
        id: qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.10.1
          arch: win64_msvc2022_64
          modules: qtmultimedia qtpositioning
          archives: qtbase qtdeclarative qtsvg qttools qttranslations
          cache: true
          use-official: true

      - name: Fetch MySQL client
        run: |
          $vcpkgRoot = Join-Path $env:GITHUB_WORKSPACE "vcpkg"
          if (-not (Test-Path $vcpkgRoot)) {
            git clone https://github.com/microsoft/vcpkg $vcpkgRoot
          }
          & "$vcpkgRoot\\bootstrap-vcpkg.bat"
          & "$vcpkgRoot\\vcpkg.exe" install libmariadb:x64-windows
          $mysqlRoot = Join-Path $vcpkgRoot "installed\\x64-windows"
          $mysqlIncludeRoot = Join-Path $mysqlRoot "include"
          $mysqlInclude = $mysqlIncludeRoot
          if (Test-Path (Join-Path $mysqlIncludeRoot "mysql\\mysql.h")) {
            $mysqlInclude = Join-Path $mysqlIncludeRoot "mysql"
          } elseif (Test-Path (Join-Path $mysqlIncludeRoot "mysql.h")) {
            $mysqlInclude = $mysqlIncludeRoot
          }
          $libCandidates = @(
            (Join-Path $mysqlRoot "lib\\libmariadb.lib")
            (Join-Path $mysqlRoot "lib\\mariadb.lib")
            (Join-Path $mysqlRoot "lib\\libmysql.lib")
            (Join-Path $mysqlRoot "lib\\mysqlclient.lib")
          )
          $mysqlLib = $libCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $mysqlLib) {
            throw "MySQL client lib not found under $mysqlRoot"
          }
          "MYSQL_INCLUDE_DIR=$mysqlInclude" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "MYSQL_CLIENT_LIB=$mysqlLib" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Fetch Rime runtime
        run: |
          $rimeDir = Join-Path $env:GITHUB_WORKSPACE "build\\rime_runtime"
          New-Item -ItemType Directory -Force -Path $rimeDir | Out-Null
          $fetchArgs = @(
            "-DRIME_OUTPUT_DIR=$rimeDir",
            "-DRIME_WITH_LUA=ON",
            "-DRIME_VERSION=1.15.0",
            "-DRIME_ASSET=rime-75bc43a-Windows-msvc-x64.7z",
            "-DRIME_WEASEL_VERSION=0.17.4",
            "-DRIME_WEASEL_ASSET=weasel-0.17.4.0-installer.exe",
            "-P",
            "$env:GITHUB_WORKSPACE\\client\\ui\\ime_rime\\FetchRime.cmake"
          )
          cmake @fetchArgs
          $rimeCandidates = @(
            (Join-Path $rimeDir "rime.dll"),
            (Join-Path $rimeDir "librime.dll")
          )
          $rimeDll = $rimeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $rimeDll) {
            $fallbackArgs = @(
              "-DRIME_OUTPUT_DIR=$rimeDir",
              "-DRIME_WITH_LUA=OFF",
              "-DRIME_VERSION=1.15.0",
              "-DRIME_ASSET=rime-75bc43a-Windows-msvc-x64.7z",
              "-P",
              "$env:GITHUB_WORKSPACE\\client\\ui\\ime_rime\\FetchRime.cmake"
            )
            cmake @fallbackArgs
            $rimeDll = $rimeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          }
          if (-not $rimeDll) {
            throw "rime runtime dll not found after FetchRime.cmake"
          }
          if (-not (Test-Path (Join-Path $rimeDir "rime.dll"))) {
            Copy-Item $rimeDll (Join-Path $rimeDir "rime.dll") -Force
          }
          "RIME_RUNTIME_DIR=$rimeDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Fetch FFmpeg runtime
        run: |
          $ffmpegRoot = Join-Path $env:GITHUB_WORKSPACE "build\\ffmpeg"
          New-Item -ItemType Directory -Force -Path $ffmpegRoot | Out-Null
          $ffmpegZip = Join-Path $ffmpegRoot "ffmpeg.zip"
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegZip
          Expand-Archive -Path $ffmpegZip -DestinationPath $ffmpegRoot -Force
          $ffmpegExe = Get-ChildItem -Path $ffmpegRoot -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          if (-not $ffmpegExe) {
            throw "ffmpeg.exe not found"
          }
          "FFMPEG_RUNTIME_DIR=$($ffmpegExe.Directory.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Fetch Real-ESRGAN runtime
        run: |
          $esrganRoot = Join-Path $env:GITHUB_WORKSPACE "build\\realesrgan"
          New-Item -ItemType Directory -Force -Path $esrganRoot | Out-Null
          $esrganZip = Join-Path $esrganRoot "realesrgan.zip"
          $esrganUrl = "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-windows.zip"
          Invoke-WebRequest -Uri $esrganUrl -OutFile $esrganZip
          Expand-Archive -Path $esrganZip -DestinationPath $esrganRoot -Force
          $esrganExe = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-ncnn-vulkan.exe" | Select-Object -First 1
          if (-not $esrganExe) {
            $esrganExe = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-ncnn.exe" | Select-Object -First 1
          }
          if (-not $esrganExe) {
            throw "realesrgan executable not found"
          }
          $modelParam = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-x4plus.param" | Select-Object -First 1
          $modelBin = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-x4plus.bin" | Select-Object -First 1
          if (-not $modelParam -or -not $modelBin) {
            throw "realesrgan model not found"
          }
          $modelDir = $modelParam.Directory.FullName
          $optionalModels = @("realesrgan-x2plus", "realesrgan-x4plus-anime")
          $modelBaseUrl = "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0"
          foreach ($model in $optionalModels) {
            $paramPath = Join-Path $modelDir "$model.param"
            $binPath = Join-Path $modelDir "$model.bin"
            if (-not (Test-Path $paramPath)) {
              try {
                Invoke-WebRequest -Uri "$modelBaseUrl/$model.param" -OutFile $paramPath -ErrorAction Stop
              } catch {
                Write-Warning "Failed to download $model.param"
              }
            }
            if (-not (Test-Path $binPath)) {
              try {
                Invoke-WebRequest -Uri "$modelBaseUrl/$model.bin" -OutFile $binPath -ErrorAction Stop
              } catch {
                Write-Warning "Failed to download $model.bin"
              }
            }
          }
          "REALESRGAN_RUNTIME_DIR=$($esrganExe.Directory.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "REALESRGAN_MODEL_DIR=$modelDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install Python deps
        run: python -m pip install --upgrade pip wordfreq

      - name: Prepare Rime dictionaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $overlayRoot = Join-Path $env:GITHUB_WORKSPACE "build\\rime_overlay"
          python .\\tools\\rime_dict_prepare.py --out $overlayRoot

      - name: Configure client
        run: >
          cmake -S client -B build/client
          -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR"
          -DMI_E2EE_BUILD_UI=ON
          -DMI_E2EE_BUILD_DEMO_CLIENT=ON
          -DMI_E2EE_BUILD_FUZZERS=OFF
          -DMI_E2EE_ENABLE_MYSQL=OFF
          -DMI_UI_RIME_DOWNLOAD=OFF
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build rime precompile tool
        run: cmake --build build/client --config Release --target mi_rime_precompile

      - name: Precompile Rime user data
        run: |
          $precompileExe = Get-ChildItem -Path $env:GITHUB_WORKSPACE\\build\\client -Recurse -Filter "mi_rime_precompile.exe" | Select-Object -First 1
          if (-not $precompileExe) {
            throw "mi_rime_precompile.exe not found"
          }
          $prebuiltRoot = Join-Path $env:GITHUB_WORKSPACE "build\\rime_prebuilt"
          New-Item -ItemType Directory -Force -Path $prebuiltRoot | Out-Null
          $runtimeDir = $env:RIME_RUNTIME_DIR
          $overlayDir = Join-Path $env:GITHUB_WORKSPACE "build\\rime_overlay\\share"
          if (-not $runtimeDir) {
            $runtimeDir = Join-Path $env:GITHUB_WORKSPACE "build\\rime_runtime"
          }
          & $precompileExe.FullName --output-dir $prebuiltRoot --runtime-dir $runtimeDir --overlay-dir $overlayDir

      - name: Verify Rime dictionaries
        run: |
          $prebuilt = Join-Path $env:GITHUB_WORKSPACE "build\\rime_prebuilt\\user"
          if (-not (Test-Path $prebuilt)) {
            throw "rime prebuilt not found: $prebuilt"
          }
          if (-not (Get-ChildItem -Path $prebuilt -Recurse -File | Select-Object -First 1)) {
            throw "rime prebuilt empty: $prebuilt"
          }
          $share = Join-Path $env:GITHUB_WORKSPACE "build\\rime_overlay\\share"
          if (-not (Test-Path $share)) {
            throw "rime overlay share not found: $share"
          }
          if (-not (Get-ChildItem -Path $share -Recurse -File | Select-Object -First 1)) {
            throw "rime overlay share empty: $share"
          }

      - name: Build client
        run: cmake --build build/client --config Release --target mi_e2ee_client mi_e2ee_client_ui_app mi_e2ee_client_ui mi_e2ee_launcher mi_ime_rime mi_e2ee_client_sdk

      - name: Build client e2e test
        run: cmake --build build/client --config Release --target sdk_c_api_e2e_test

      - name: Run client e2e test
        env:
          MI_E2EE_HARDENING: off
        run: ctest --test-dir build/client -C Release -R sdk_c_api_e2e_test --output-on-failure

      - name: Build Rust bindings
        run: |
          $env:MI_E2EE_CLIENT_LIB_DIR = Join-Path $env:GITHUB_WORKSPACE "build\\client\\Release"
          cargo build --manifest-path bindings/rust/Cargo.toml --examples

      - name: Python binding smoke
        run: |
          $env:MI_E2EE_CLIENT_DLL = Join-Path $env:GITHUB_WORKSPACE "build\\client\\Release\\mi_e2ee_client_sdk.dll"
          python bindings\\python\\smoke_quiet.py

      - name: Rust binding smoke
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}\build\client\Release
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\\build\\client\\Release;$env:PATH"
          cargo run --manifest-path bindings/rust/Cargo.toml --example smoke --quiet

      - name: Configure server
        run: >
          cmake -S server -B build/server
          -DMI_E2EE_ENABLE_MYSQL=ON
          -DMYSQL_INCLUDE_DIR="${{ env.MYSQL_INCLUDE_DIR }}"
          -DMYSQL_CLIENT_LIB="${{ env.MYSQL_CLIENT_LIB }}"
          -DBUILD_TESTING=ON
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build server
        run: cmake --build build/server --config Release --target mi_e2ee_server mi_e2ee_server_launcher mi_e2ee_kt_keygen mi_e2ee_kt_pubinfo mi_e2ee_perf_baseline mi_e2ee_ops_health_view mi_e2ee_third_party_audit

      - name: Build ops health test
        run: cmake --build build/server --config Release --target ops_health_test

      - name: Run ops health test
        run: ctest --test-dir build/server -C Release -R ops_health_test --output-on-failure

      - name: Ops health end-to-end
        run: |
          $ErrorActionPreference = "Stop"
          $work = Join-Path $env:GITHUB_WORKSPACE "build\\ops_health_runtime"
          New-Item -ItemType Directory -Force -Path $work | Out-Null
          $offline = Join-Path $work "offline"
          New-Item -ItemType Directory -Force -Path $offline | Out-Null
          $testUsers = Join-Path $work "test_user.txt"
          "u:p" | Out-File -FilePath $testUsers -Encoding ascii
          $ktKey = Join-Path $work "kt_signing_key.bin"
          $bytes = New-Object byte[] 4032
          [System.Security.Cryptography.RandomNumberGenerator]::Create().GetBytes($bytes)
          [System.IO.File]::WriteAllBytes($ktKey, $bytes)
          $listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Loopback, 0)
          $listener.Start()
          $port = $listener.LocalEndpoint.Port
          $listener.Stop()
          $token = "abcdefghijklmnop"
          $config = @(
            "[mode]"
            "mode=1"
            "[server]"
            "list_port=$port"
            "offline_dir=$offline"
            "ops_enable=1"
            "ops_allow_remote=0"
            "ops_token=$token"
            "tls_enable=0"
            "require_tls=0"
            "key_protection=none"
            "kt_signing_key=$ktKey"
            "allow_legacy_login=0"
          ) -join "`n"
          $configPath = Join-Path $work "config.ini"
          $config | Out-File -FilePath $configPath -Encoding ascii
          $serverExe = Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE "build\\server") -Recurse -Filter "mi_e2ee_server.exe" | Select-Object -First 1
          if (-not $serverExe) {
            throw "mi_e2ee_server.exe not found"
          }
          $toolExe = Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE "build\\server") -Recurse -Filter "mi_e2ee_ops_health_view.exe" | Select-Object -First 1
          if (-not $toolExe) {
            throw "mi_e2ee_ops_health_view.exe not found"
          }
          $env:MI_E2EE_HARDENING = "off"
          $proc = Start-Process -FilePath $serverExe.FullName -ArgumentList @("config.ini") -WorkingDirectory $work -PassThru -WindowStyle Hidden
          try {
            $ok = $false
            for ($i = 0; $i -lt 20; $i++) {
              & $toolExe.FullName --host 127.0.0.1 --port $port --token $token 2>$null | Out-Null
              if ($LASTEXITCODE -eq 0) {
                $ok = $true
                break
              }
              Start-Sleep -Milliseconds 500
            }
            if (-not $ok) {
              throw "ops health e2e failed"
            }
          } finally {
            if ($proc -and !$proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
          }

      - name: Perf baseline
        run: .\\build\\server\\tools\\Release\\mi_e2ee_perf_baseline.exe --quick

      - name: Deploy Qt runtime
        run: |
          $qtRoot = "${{ steps.qt.outputs.qt-path }}"
          if (-not $qtRoot) {
            $qtRoot = $env:QT_ROOT_DIR
          }
          if (-not $qtRoot) {
            throw "Qt root dir not found"
          }
          $qtBin = Join-Path $qtRoot "bin"
          & (Join-Path $qtBin "windeployqt.exe") --release --compiler-runtime --qmldir $env:GITHUB_WORKSPACE\\client\\ui $env:GITHUB_WORKSPACE\\build\\client\\ui\\Release\\mi_e2ee_client_ui_app.exe
          $uiRoot = Join-Path $env:GITHUB_WORKSPACE "build\\client\\ui\\Release"
          $qmlRoot = Join-Path $uiRoot "qml"
          $qtQmlCoreDll = Join-Path $qtBin "Qt6QmlCore.dll"
          if (Test-Path $qtQmlCoreDll) {
            Copy-Item $qtQmlCoreDll $uiRoot -Force
          }
          $qtQmlCoreModule = Join-Path $qtRoot "qml\\QtCore"
          $dstQmlCoreModule = Join-Path $qmlRoot "QtCore"
          if ((Test-Path $qtQmlCoreModule) -and (-not (Test-Path $dstQmlCoreModule))) {
            New-Item -ItemType Directory -Force -Path $qmlRoot | Out-Null
            Copy-Item $qtQmlCoreModule $dstQmlCoreModule -Recurse -Force
          }

      - name: UI smoke regression
        env:
          MI_E2EE_UI_SMOKE: "1"
          MI_E2EE_UI_SMOKE_MS: "4000"
          MI_E2EE_UI_SMOKE_USER: "ui_smoke"
          MI_E2EE_UI_SMOKE_PASS: "ui_smoke_pass"
          MI_E2EE_HARDENING: off
          QT_LOGGING_RULES: "*.debug=false;*.info=false;*.warning=false"
        run: |
          $ErrorActionPreference = "Stop"
          $work = Join-Path $env:GITHUB_WORKSPACE "build\\ui_smoke_runtime"
          New-Item -ItemType Directory -Force -Path $work | Out-Null
          $offline = Join-Path $work "offline"
          New-Item -ItemType Directory -Force -Path $offline | Out-Null
          $testUsers = Join-Path $work "test_user.txt"
          "ui_smoke:ui_smoke_pass" | Out-File -FilePath $testUsers -Encoding ascii
          $ktKey = Join-Path $work "kt_signing_key.bin"
          $bytes = New-Object byte[] 4032
          [System.Security.Cryptography.RandomNumberGenerator]::Create().GetBytes($bytes)
          [System.IO.File]::WriteAllBytes($ktKey, $bytes)
          $listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Loopback, 0)
          $listener.Start()
          $port = $listener.LocalEndpoint.Port
          $listener.Stop()
          $serverConfig = @(
            "[mode]"
            "mode=1"
            "[server]"
            "list_port=$port"
            "offline_dir=$offline"
            "debug_log=0"
            "tls_enable=0"
            "require_tls=0"
            "key_protection=none"
            "kt_signing_key=$ktKey"
            "allow_legacy_login=0"
          ) -join "`n"
          $serverConfigPath = Join-Path $work "config.ini"
          $serverConfig | Out-File -FilePath $serverConfigPath -Encoding ascii
          $clientConfig = @(
            "[client]"
            "server_ip=127.0.0.1"
            "server_port=$port"
            "use_tls=0"
            "require_tls=0"
            "tls_verify_mode=ca"
            "auth_mode=opaque"
            "allow_legacy_login=0"
            "[traffic]"
            "cover_traffic_enabled=0"
            "[kt]"
            "require_signature=0"
            "[device_sync]"
            "enabled=0"
            "role=primary"
            "ratchet_enable=1"
          ) -join "`n"
          $clientConfigPath = Join-Path $work "client_config.ini"
          $clientConfig | Out-File -FilePath $clientConfigPath -Encoding ascii
          $env:MI_E2EE_UI_SMOKE_CONFIG = $clientConfigPath
          $serverExe = Get-ChildItem -Path (Join-Path $env:GITHUB_WORKSPACE "build\\server") -Recurse -Filter "mi_e2ee_server.exe" | Select-Object -First 1
          if (-not $serverExe) {
            throw "mi_e2ee_server.exe not found"
          }
          $exe = Get-ChildItem -Path $env:GITHUB_WORKSPACE\\build\\client\\ui\\Release -Filter "mi_e2ee_client_ui_app.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "mi_e2ee_client_ui_app.exe not found"
          }
          $proc = Start-Process -FilePath $serverExe.FullName -ArgumentList @("config.ini") -WorkingDirectory $work -PassThru -WindowStyle Hidden
          try {
            $ready = $false
            for ($i = 0; $i -lt 25; $i++) {
              try {
                $tcp = New-Object System.Net.Sockets.TcpClient
                $tcp.Connect("127.0.0.1", $port)
                $tcp.Close()
                $ready = $true
                break
              } catch {
                Start-Sleep -Milliseconds 200
              }
            }
            if (-not $ready) {
              throw "server not ready"
            }
            Push-Location $exe.Directory.FullName
            try {
              & $exe.FullName | Out-Null
              if ($LASTEXITCODE -ne 0) {
                throw "UI smoke failed with exit code $LASTEXITCODE"
              }
            } finally {
              Pop-Location
            }
          } finally {
            if ($proc -and !$proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
          }

      - name: Package artifacts
        run: .\\tools\\package_windows.ps1

      - name: Verify package
        run: .\\tools\\verify_package_windows.ps1

      - name: Perf baseline (dist)
        run: .\\dist\\mi_e2ee_server\\tools\\mi_e2ee_perf_baseline.exe --quick

      - name: Upload client package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_client
          path: dist/mi_e2ee_client.zip

      - name: Upload server package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_server
          path: dist/mi_e2ee_server.zip

  build-linux:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Install OpenSSL
        run: sudo apt-get update && sudo apt-get install -y libssl-dev libsecret-1-dev pkg-config openssl

      - name: Configure server
        run: cmake -S server -B build/server -DMI_E2EE_ENABLE_MYSQL=OFF -DBUILD_TESTING=ON

      - name: Build server
        run: cmake --build build/server --config Release

      - name: Run server tests
        env:
          MI_E2EE_HARDENING: off
        run: ctest --test-dir build/server -C Release --output-on-failure

      - name: Ops health end-to-end
        env:
          MI_E2EE_HARDENING: off
        run: |
          set -euo pipefail
          work="$GITHUB_WORKSPACE/build/ops_health_runtime"
          rm -rf "$work"
          mkdir -p "$work/offline"
          printf "u:p\n" > "$work/test_user.txt"
          head -c 4032 /dev/urandom > "$work/kt_signing_key.bin"
          py="python3"
          if ! command -v "$py" >/dev/null 2>&1; then
            py="python"
          fi
          port=$("$py" -c 'import socket; s=socket.socket(); s.bind(("127.0.0.1", 0)); print(s.getsockname()[1]); s.close()')
          token="abcdefghijklmnop"
          printf '%s\n' \
            "[mode]" \
            "mode=1" \
            "[server]" \
            "list_port=$port" \
            "offline_dir=$work/offline" \
            "ops_enable=1" \
            "ops_allow_remote=0" \
            "ops_token=$token" \
            "debug_log=0" \
            "tls_enable=0" \
            "require_tls=0" \
            "key_protection=none" \
            "kt_signing_key=$work/kt_signing_key.bin" \
            "allow_legacy_login=0" \
            > "$work/config.ini"
          server=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_server" -perm -111 | head -n 1)
          if [ -z "$server" ]; then
            echo "mi_e2ee_server not found" >&2
            exit 1
          fi
          tool=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_ops_health_view" -perm -111 | head -n 1)
          if [ -z "$tool" ]; then
            echo "mi_e2ee_ops_health_view not found" >&2
            exit 1
          fi
          cd "$work"
          "$server" config.ini >/dev/null 2>&1 &
          pid=$!
          ok=0
          for _ in $(seq 1 20); do
            if "$tool" --host 127.0.0.1 --port "$port" --token "$token" >/dev/null 2>&1; then
              ok=1
              break
            fi
            sleep 0.5
          done
          kill "$pid" >/dev/null 2>&1 || true
          wait "$pid" >/dev/null 2>&1 || true
          if [ "$ok" -ne 1 ]; then
            echo "ops health e2e failed" >&2
            exit 1
          fi

      - name: Ops health end-to-end
        env:
          MI_E2EE_HARDENING: off
        run: |
          set -euo pipefail
          work="$GITHUB_WORKSPACE/build/ops_health_runtime"
          rm -rf "$work"
          mkdir -p "$work/offline"
          printf "u:p\n" > "$work/test_user.txt"
          head -c 4032 /dev/urandom > "$work/kt_signing_key.bin"
          py="python3"
          if ! command -v "$py" >/dev/null 2>&1; then
            py="python"
          fi
          port=$("$py" -c 'import socket; s=socket.socket(); s.bind(("127.0.0.1", 0)); print(s.getsockname()[1]); s.close()')
          token="abcdefghijklmnop"
          printf '%s\n' \
            "[mode]" \
            "mode=1" \
            "[server]" \
            "list_port=$port" \
            "offline_dir=$work/offline" \
            "ops_enable=1" \
            "ops_allow_remote=0" \
            "ops_token=$token" \
            "debug_log=0" \
            "tls_enable=0" \
            "require_tls=0" \
            "key_protection=none" \
            "kt_signing_key=$work/kt_signing_key.bin" \
            "allow_legacy_login=0" \
            > "$work/config.ini"
          server=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_server" -perm -111 | head -n 1)
          if [ -z "$server" ]; then
            echo "mi_e2ee_server not found" >&2
            exit 1
          fi
          tool=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_ops_health_view" -perm -111 | head -n 1)
          if [ -z "$tool" ]; then
            echo "mi_e2ee_ops_health_view not found" >&2
            exit 1
          fi
          cd "$work"
          "$server" config.ini >/dev/null 2>&1 &
          pid=$!
          ok=0
          for _ in $(seq 1 20); do
            if "$tool" --host 127.0.0.1 --port "$port" --token "$token" >/dev/null 2>&1; then
              ok=1
              break
            fi
            sleep 0.5
          done
          kill "$pid" >/dev/null 2>&1 || true
          wait "$pid" >/dev/null 2>&1 || true
          if [ "$ok" -ne 1 ]; then
            echo "ops health e2e failed" >&2
            exit 1
          fi

      - name: Configure client
        run: cmake -S client -B build/client -DMI_E2EE_BUILD_UI=OFF -DMI_E2EE_BUILD_DEMO_CLIENT=OFF -DMI_E2EE_ENABLE_MYSQL=OFF

      - name: Build client core
        run: cmake --build build/client --config Release --target mi_e2ee_client_core mi_e2ee_client_sdk

      - name: Build client e2e test
        run: cmake --build build/client --config Release --target sdk_c_api_e2e_test

      - name: Run client e2e test
        env:
          MI_E2EE_HARDENING: off
        run: ctest --test-dir build/client -R sdk_c_api_e2e_test --output-on-failure

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust bindings
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: cargo build --manifest-path bindings/rust/Cargo.toml --examples

      - name: Python binding smoke
        env:
          MI_E2EE_CLIENT_DLL: ${{ github.workspace }}/build/client/libmi_e2ee_client_sdk.so
        run: python bindings/python/smoke_quiet.py

      - name: Rust binding smoke
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: |
          export LD_LIBRARY_PATH="${{ github.workspace }}/build/client:${LD_LIBRARY_PATH:-}"
          cargo run --manifest-path bindings/rust/Cargo.toml --example smoke --quiet

      - name: Package artifacts
        run: bash tools/package_posix.sh --platform linux

      - name: Verify package
        run: bash tools/verify_package_posix.sh --platform linux

      - name: Upload client package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_client_linux
          path: dist/mi_e2ee_client_linux.tar.gz

      - name: Upload server package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_server_linux
          path: dist/mi_e2ee_server_linux.tar.gz

  build-linux-debian:
    runs-on: ubuntu-latest
    container:
      image: buildpack-deps:bookworm
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates \
            cmake \
            pkg-config \
            libssl-dev \
            libsecret-1-dev \
            openssl \
            python3 \
            python3-pip

      - name: Configure server
        run: cmake -S server -B build/server -DMI_E2EE_ENABLE_MYSQL=OFF -DBUILD_TESTING=ON

      - name: Build server
        run: cmake --build build/server --config Release

      - name: Run server tests
        env:
          MI_E2EE_HARDENING: off
        run: ctest --test-dir build/server -C Release --output-on-failure

      - name: Ops health end-to-end
        env:
          MI_E2EE_HARDENING: off
        run: |
          set -euo pipefail
          work="$GITHUB_WORKSPACE/build/ops_health_runtime"
          rm -rf "$work"
          mkdir -p "$work/offline"
          printf "u:p\n" > "$work/test_user.txt"
          head -c 4032 /dev/urandom > "$work/kt_signing_key.bin"
          py="python3"
          if ! command -v "$py" >/dev/null 2>&1; then
            py="python"
          fi
          port=$("$py" -c 'import socket; s=socket.socket(); s.bind(("127.0.0.1", 0)); print(s.getsockname()[1]); s.close()')
          token="abcdefghijklmnop"
          printf '%s\n' \
            "[mode]" \
            "mode=1" \
            "[server]" \
            "list_port=$port" \
            "offline_dir=$work/offline" \
            "ops_enable=1" \
            "ops_allow_remote=0" \
            "ops_token=$token" \
            "debug_log=0" \
            "tls_enable=0" \
            "require_tls=0" \
            "key_protection=none" \
            "kt_signing_key=$work/kt_signing_key.bin" \
            "allow_legacy_login=0" \
            > "$work/config.ini"
          server=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_server" -perm -111 | head -n 1)
          if [ -z "$server" ]; then
            echo "mi_e2ee_server not found" >&2
            exit 1
          fi
          tool=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_ops_health_view" -perm -111 | head -n 1)
          if [ -z "$tool" ]; then
            echo "mi_e2ee_ops_health_view not found" >&2
            exit 1
          fi
          cd "$work"
          "$server" config.ini >/dev/null 2>&1 &
          pid=$!
          ok=0
          for _ in $(seq 1 20); do
            if "$tool" --host 127.0.0.1 --port "$port" --token "$token" >/dev/null 2>&1; then
              ok=1
              break
            fi
            sleep 0.5
          done
          kill "$pid" >/dev/null 2>&1 || true
          wait "$pid" >/dev/null 2>&1 || true
          if [ "$ok" -ne 1 ]; then
            echo "ops health e2e failed" >&2
            exit 1
          fi

      - name: Configure client
        run: cmake -S client -B build/client -DMI_E2EE_BUILD_UI=OFF -DMI_E2EE_BUILD_DEMO_CLIENT=OFF -DMI_E2EE_ENABLE_MYSQL=OFF

      - name: Build client core
        run: cmake --build build/client --config Release --target mi_e2ee_client_core mi_e2ee_client_sdk

      - name: Build client e2e test
        run: cmake --build build/client --config Release --target sdk_c_api_e2e_test

      - name: Run client e2e test
        env:
          MI_E2EE_HARDENING: off
        run: ctest --test-dir build/client -R sdk_c_api_e2e_test --output-on-failure

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust bindings
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: cargo build --manifest-path bindings/rust/Cargo.toml --examples

      - name: Python binding smoke
        env:
          MI_E2EE_CLIENT_DLL: ${{ github.workspace }}/build/client/libmi_e2ee_client_sdk.so
        run: python3 bindings/python/smoke_quiet.py

      - name: Rust binding smoke
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: |
          export LD_LIBRARY_PATH="${{ github.workspace }}/build/client:${LD_LIBRARY_PATH:-}"
          cargo run --manifest-path bindings/rust/Cargo.toml --example smoke --quiet

      - name: Package artifacts
        run: bash tools/package_posix.sh --platform linux

      - name: Verify package
        run: bash tools/verify_package_posix.sh --platform linux

  build-macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Install OpenSSL
        run: brew install openssl@3 pkg-config

      - name: Configure server
        run: cmake -S server -B build/server -DMI_E2EE_ENABLE_MYSQL=OFF -DBUILD_TESTING=ON -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)

      - name: Build server
        run: cmake --build build/server --config Release

      - name: Run server tests
        env:
          MI_E2EE_HARDENING: off
        run: ctest --test-dir build/server -C Release --output-on-failure

      - name: Ops health end-to-end
        env:
          MI_E2EE_HARDENING: off
        run: |
          set -euo pipefail
          work="$GITHUB_WORKSPACE/build/ops_health_runtime"
          rm -rf "$work"
          mkdir -p "$work/offline"
          printf "u:p\n" > "$work/test_user.txt"
          head -c 4032 /dev/urandom > "$work/kt_signing_key.bin"
          py="python3"
          if ! command -v "$py" >/dev/null 2>&1; then
            py="python"
          fi
          port=$("$py" -c 'import socket; s=socket.socket(); s.bind(("127.0.0.1", 0)); print(s.getsockname()[1]); s.close()')
          token="abcdefghijklmnop"
          printf '%s\n' \
            "[mode]" \
            "mode=1" \
            "[server]" \
            "list_port=$port" \
            "offline_dir=$work/offline" \
            "ops_enable=1" \
            "ops_allow_remote=0" \
            "ops_token=$token" \
            "debug_log=0" \
            "tls_enable=0" \
            "require_tls=0" \
            "key_protection=none" \
            "kt_signing_key=$work/kt_signing_key.bin" \
            "allow_legacy_login=0" \
            > "$work/config.ini"
          server=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_server" -perm -111 | head -n 1)
          if [ -z "$server" ]; then
            echo "mi_e2ee_server not found" >&2
            exit 1
          fi
          tool=$(find "$GITHUB_WORKSPACE/build/server" -type f -name "mi_e2ee_ops_health_view" -perm -111 | head -n 1)
          if [ -z "$tool" ]; then
            echo "mi_e2ee_ops_health_view not found" >&2
            exit 1
          fi
          cd "$work"
          "$server" config.ini >/dev/null 2>&1 &
          pid=$!
          ok=0
          for _ in $(seq 1 20); do
            if "$tool" --host 127.0.0.1 --port "$port" --token "$token" >/dev/null 2>&1; then
              ok=1
              break
            fi
            sleep 0.5
          done
          kill "$pid" >/dev/null 2>&1 || true
          wait "$pid" >/dev/null 2>&1 || true
          if [ "$ok" -ne 1 ]; then
            echo "ops health e2e failed" >&2
            exit 1
          fi

      - name: Configure client
        run: cmake -S client -B build/client -DMI_E2EE_BUILD_UI=OFF -DMI_E2EE_BUILD_DEMO_CLIENT=OFF -DMI_E2EE_ENABLE_MYSQL=OFF -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)

      - name: Build client core
        run: cmake --build build/client --config Release --target mi_e2ee_client_core mi_e2ee_client_sdk

      - name: Build client e2e test
        run: cmake --build build/client --config Release --target sdk_c_api_e2e_test

      - name: Run client e2e test
        env:
          MI_E2EE_HARDENING: off
        run: ctest --test-dir build/client -R sdk_c_api_e2e_test --output-on-failure

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust bindings
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: cargo build --manifest-path bindings/rust/Cargo.toml --examples

      - name: Python binding smoke
        env:
          MI_E2EE_CLIENT_DLL: ${{ github.workspace }}/build/client/libmi_e2ee_client_sdk.dylib
        run: python bindings/python/smoke_quiet.py

      - name: Rust binding smoke
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: |
          export DYLD_LIBRARY_PATH="${{ github.workspace }}/build/client:${DYLD_LIBRARY_PATH:-}"
          cargo run --manifest-path bindings/rust/Cargo.toml --example smoke --quiet

      - name: Package artifacts
        run: bash tools/package_posix.sh --platform macos --openssl "$(brew --prefix openssl@3)/bin/openssl"

      - name: Verify package
        run: bash tools/verify_package_posix.sh --platform macos

      - name: Upload client package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_client_macos
          path: dist/mi_e2ee_client_macos.tar.gz

      - name: Upload server package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_server_macos
          path: dist/mi_e2ee_server_macos.tar.gz

  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      MI_E2EE_ANDROID_OLLVM: ${{ vars.MI_E2EE_ANDROID_OLLVM || '1' }}
      MI_E2EE_OLLVM_URL_TEMPLATE: ${{ vars.MI_E2EE_OLLVM_URL_TEMPLATE || '' }}
      MI_E2EE_ANDROID_NDK_VERSION: ${{ vars.MI_E2EE_ANDROID_NDK_VERSION || '25.2.9519653' }}
      MI_E2EE_OLLVM_FALLBACK_URL: ${{ vars.MI_E2EE_OLLVM_FALLBACK_URL || 'https://github.com/codetronik/ollvm-ndk/releases/download/r23c-release/clang' }}
      MI_E2EE_ANDROID_USE_OPENSSL: "1"
      MI_E2EE_ANDROID_ALLOW_TLS_STUB: "0"
      MI_E2EE_ANDROID_OPENSSL_VERSION: ${{ vars.MI_E2EE_ANDROID_OPENSSL_VERSION || '3.3.2' }}
      GCP_SERVICE_ACCOUNT_JSON: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_RESULTS_BUCKET: ${{ secrets.GCP_RESULTS_BUCKET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install OLLVM host deps
        run: |
          sudo apt-get update
          if ! sudo apt-get install -y libtinfo5 libncurses5 libc++1 libc++abi1; then
            sudo apt-get install -y libtinfo6 libncurses6 libc++1 libc++abi1
          fi

      - name: Install Android components
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "platforms;android-33" "build-tools;34.0.0" "cmake;3.22.1" "ndk;${MI_E2EE_ANDROID_NDK_VERSION}" "emulator" "system-images;android-34;google_apis;x86_64" "system-images;android-33;google_apis;x86"

      - name: Resolve Android NDK root
        run: |
          set -euo pipefail
          NDK_ROOT="$ANDROID_SDK_ROOT/ndk/$MI_E2EE_ANDROID_NDK_VERSION"
          if [ ! -d "$NDK_ROOT" ]; then
            NDK_ROOT=$(ls -d "$ANDROID_SDK_ROOT/ndk/"* 2>/dev/null | sort -V | tail -n 1)
          fi
          if [ -z "$NDK_ROOT" ] || [ ! -d "$NDK_ROOT" ]; then
            echo "NDK not found under $ANDROID_SDK_ROOT/ndk" >&2
            exit 1
          fi
          echo "ANDROID_NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$NDK_ROOT" >> $GITHUB_ENV

      - name: Build OpenSSL for Android
        run: |
          set -euo pipefail
          chmod +x tools/build_android_openssl.sh
          tools/build_android_openssl.sh \
            --ndk "$ANDROID_NDK_ROOT" \
            --out "$GITHUB_WORKSPACE/build/openssl/android" \
            --version "$MI_E2EE_ANDROID_OPENSSL_VERSION" \
            --api 24
          echo "MI_E2EE_ANDROID_OPENSSL_ROOT=$GITHUB_WORKSPACE/build/openssl/android" >> $GITHUB_ENV

      - name: Prepare OLLVM URL
        if: env.MI_E2EE_ANDROID_OLLVM == '1' || env.MI_E2EE_ANDROID_OLLVM == 'true'
        run: |
          set -euo pipefail
          NDK_ROOT="$ANDROID_SDK_ROOT/ndk/$MI_E2EE_ANDROID_NDK_VERSION"
          if [ ! -d "$NDK_ROOT" ]; then
            NDK_ROOT=$(ls -d "$ANDROID_SDK_ROOT/ndk/"* 2>/dev/null | sort -V | tail -n 1)
          fi
          if [ -z "$NDK_ROOT" ]; then
            echo "NDK not found under $ANDROID_SDK_ROOT/ndk" >&2
            exit 1
          fi
          CLANG_BIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang"
          if [ ! -x "$CLANG_BIN" ]; then
            echo "clang not found: $CLANG_BIN" >&2
            exit 1
          fi
          LLVM_FULL=$("$CLANG_BIN" --version | head -n 1 | sed -E 's/.*clang version ([0-9]+\\.[0-9]+\\.[0-9]+).*/\\1/')
          if [ -z "$LLVM_FULL" ]; then
            echo "Failed to parse clang version from $CLANG_BIN" >&2
            exit 1
          fi
          LLVM_MAJOR=$(echo "$LLVM_FULL" | cut -d. -f1)
          NDK_REV=$(grep -E '^Pkg.Revision' "$NDK_ROOT/source.properties" | cut -d= -f2 | tr -d ' ')
          URL=""
          if [ -n "${MI_E2EE_OLLVM_URL_TEMPLATE:-}" ]; then
            URL="$MI_E2EE_OLLVM_URL_TEMPLATE"
            URL="${URL//\\{LLVM_FULL\\}/$LLVM_FULL}"
            URL="${URL//\\{LLVM_MAJOR\\}/$LLVM_MAJOR}"
          else
            OLLVM_NDK_TAG=""
            case "$NDK_REV" in
              25.2.*) OLLVM_NDK_TAG="r25c" ;;
              26.*) OLLVM_NDK_TAG="r26d" ;;
              23.2.*) OLLVM_NDK_TAG="r23c" ;;
            esac
            if [ -z "$OLLVM_NDK_TAG" ]; then
              echo "Unsupported NDK revision for default OLLVM mapping: $NDK_REV" >&2
              echo "Set MI_E2EE_OLLVM_URL_TEMPLATE to override." >&2
              exit 1
            fi
            URL="https://github.com/Saint-Theana/ollvm-ndk-android/releases/download/0.0/android-ndk-${OLLVM_NDK_TAG}-linux.tar.gz"
            if ! curl -sfI "$URL" >/dev/null; then
              URL="https://github.com/Saint-Theana/ollvm-ndk-android/releases/download/0.0/android-ndk-${OLLVM_NDK_TAG}-android.tar.gz"
            fi
          fi
          if [ -z "$URL" ]; then
            echo "OLLVM URL is empty" >&2
            exit 1
          fi
          mkdir -p build/ollvm
          echo "$NDK_REV|$LLVM_FULL|$URL" > build/ollvm/cache_key.txt
          echo "NDK_REV=$NDK_REV" >> $GITHUB_ENV
          echo "OLLVM_URL=$URL" >> $GITHUB_ENV

      - name: Cache OLLVM download
        if: env.MI_E2EE_ANDROID_OLLVM == '1' || env.MI_E2EE_ANDROID_OLLVM == 'true'
        uses: actions/cache@v4
        with:
          path: build/ollvm/ollvm.tar.gz
          key: ollvm-${{ runner.os }}-${{ hashFiles('build/ollvm/cache_key.txt') }}

      - name: Fetch OLLVM toolchain
        if: env.MI_E2EE_ANDROID_OLLVM == '1' || env.MI_E2EE_ANDROID_OLLVM == 'true'
        run: |
          set -euo pipefail
          OLLVM_VALID=1
          if [ -z "${OLLVM_URL:-}" ]; then
            echo "OLLVM_URL not set. Falling back to standalone OLLVM clang." >&2
            OLLVM_VALID=0
          else
            echo "Using OLLVM URL: $OLLVM_URL"
            mkdir -p build/ollvm
            if [ ! -f build/ollvm/ollvm.tar.gz ]; then
              curl -L "$OLLVM_URL" -o build/ollvm/ollvm.tar.gz
            fi
            tar -xf build/ollvm/ollvm.tar.gz -C build/ollvm
            OLLVM_NDK_ROOT=$(find build/ollvm -type f -name source.properties -print -quit | xargs -r dirname)
            if [ -z "$OLLVM_NDK_ROOT" ]; then
              echo "OLLVM NDK root not found in build/ollvm" >&2
              OLLVM_VALID=0
            else
              OLLVM_CLANG="$OLLVM_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang"
              OLLVM_CLANGXX="$OLLVM_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++"
              if [ ! -x "$OLLVM_CLANG" ] || [ ! -x "$OLLVM_CLANGXX" ]; then
                echo "OLLVM clang binaries not found in $OLLVM_NDK_ROOT" >&2
                OLLVM_VALID=0
              fi
            fi
          fi
          if [ "$OLLVM_VALID" = "1" ]; then
            if ! "$OLLVM_CLANG" --version >/dev/null 2>&1; then
              echo "OLLVM clang is not runnable on this runner. Falling back." >&2
              OLLVM_VALID=0
            fi
          fi
          if [ "$OLLVM_VALID" = "1" ]; then
            OLLVM_CLANG=$(realpath "$OLLVM_CLANG")
            OLLVM_CLANGXX=$(realpath "$OLLVM_CLANGXX")
            OLLVM_NDK_ROOT=$(realpath "$OLLVM_NDK_ROOT")
            echo "MI_E2EE_OLLVM_CLANG=$OLLVM_CLANG" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_CLANGXX=$OLLVM_CLANGXX" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_NDK=$OLLVM_NDK_ROOT" >> $GITHUB_ENV
          else
            FALLBACK_URL="${MI_E2EE_OLLVM_FALLBACK_URL}"
            FALLBACK_DIR="build/ollvm/fallback/bin"
            mkdir -p "$FALLBACK_DIR"
            curl -L "$FALLBACK_URL" -o "$FALLBACK_DIR/clang"
            chmod +x "$FALLBACK_DIR/clang"
            printf '%s\n' \
              '#!/usr/bin/env bash' \
              'DIR=$(cd "$(dirname "$0")" && pwd)' \
              'exec "$DIR/clang" --driver-mode=g++ "$@"' \
              > "$FALLBACK_DIR/clang++"
            chmod +x "$FALLBACK_DIR/clang++"
            if ! "$FALLBACK_DIR/clang" --version >/dev/null 2>build/ollvm/fallback/clang_error.log; then
              echo "Fallback OLLVM clang is not runnable on this runner." >&2
              cat build/ollvm/fallback/clang_error.log >&2 || true
              file "$FALLBACK_DIR/clang" >&2 || true
              ldd "$FALLBACK_DIR/clang" >&2 || true
              exit 1
            fi
            OLLVM_CLANG=$(realpath "$FALLBACK_DIR/clang")
            OLLVM_CLANGXX=$(realpath "$FALLBACK_DIR/clang++")
            echo "MI_E2EE_OLLVM_CLANG=$OLLVM_CLANG" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_CLANGXX=$OLLVM_CLANGXX" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_NDK=" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_FALLBACK=1" >> $GITHUB_ENV
          fi

      - name: Configure local.properties
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties

      - name: Build Android debug
        run: |
          chmod +x android/gradlew
          cd android
          ./gradlew :app:assembleDebug -PmiE2eeOpaque=false --no-daemon

      - name: Verify Android ABI artifacts
        run: |
          set -euo pipefail
          apk="android/app/build/outputs/apk/debug/app-debug.apk"
          if [ ! -f "$apk" ]; then
            echo "debug apk missing: $apk" >&2
            exit 1
          fi
          for abi in armeabi-v7a arm64-v8a x86 x86_64; do
            for lib in libmi_e2ee_backend.so libmi_e2ee_jni.so; do
              if ! unzip -l "$apk" | grep -q "lib/${abi}/${lib}$"; then
                echo "missing ${lib} for ${abi}" >&2
                exit 1
              fi
            done
          done

      - name: Run Android instrumentation tests (x86_64)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim
          script: |
            cd android
            ./gradlew :app:connectedDebugAndroidTest -PmiE2eeOpaque=false --no-daemon

      - name: Run Android instrumentation tests (x86)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86
          profile: Nexus 6
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim
          script: |
            cd android
            ./gradlew :app:connectedDebugAndroidTest -PmiE2eeOpaque=false --no-daemon

      - name: Auth to Google Cloud
        if: ${{ env.GCP_SERVICE_ACCOUNT_JSON != '' && env.GCP_PROJECT_ID != '' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SERVICE_ACCOUNT_JSON }}

      - name: Setup gcloud
        if: ${{ env.GCP_SERVICE_ACCOUNT_JSON != '' && env.GCP_PROJECT_ID != '' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: 'firebase'

      - name: Firebase Test Lab (arm64)
        if: ${{ env.GCP_SERVICE_ACCOUNT_JSON != '' && env.GCP_PROJECT_ID != '' }}
        env:
          FTL_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
          FTL_RESULTS_BUCKET: ${{ env.GCP_RESULTS_BUCKET }}
          FTL_DEVICE_MATRIX: ${{ vars.MI_E2EE_FTL_DEVICE_MATRIX }}
        run: |
          set -euo pipefail
          cd android
          ./gradlew :app:assembleDebugAndroidTest -PmiE2eeOpaque=false --no-daemon
          app_apk="app/build/outputs/apk/debug/app-debug.apk"
          test_apk="app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk"
          if [ ! -f "$app_apk" ] || [ ! -f "$test_apk" ]; then
            echo "Firebase Test Lab artifacts missing" >&2
            exit 1
          fi
          args=(firebase test android run --type instrumentation --app "$app_apk" --test "$test_apk" --timeout 15m --project "$FTL_PROJECT_ID")
          if [ -n "${FTL_RESULTS_BUCKET:-}" ]; then
            args+=(--results-bucket "$FTL_RESULTS_BUCKET")
          fi
          if [ -n "${FTL_DEVICE_MATRIX:-}" ]; then
            IFS=';' read -r -a devices <<< "$FTL_DEVICE_MATRIX"
            for device in "${devices[@]}"; do
              if [ -n "$device" ]; then
                args+=(--device "$device")
              fi
            done
          else
            args+=(--device "model=Pixel2,version=30,locale=en,orientation=portrait")
            args+=(--device "model=Pixel3,version=33,locale=en,orientation=portrait")
          fi
          gcloud "${args[@]}"

      - name: Build Android release
        run: |
          chmod +x android/gradlew
          cd android
          OLLVM_ARGS=()
          if [ "${MI_E2EE_ANDROID_OLLVM}" = "1" ] || [ "${MI_E2EE_ANDROID_OLLVM}" = "true" ]; then
            OLLVM_ARGS+=("-PmiE2eeOllvm=true")
            OLLVM_ARGS+=("-PmiE2eeOllvmClang=${MI_E2EE_OLLVM_CLANG}")
            OLLVM_ARGS+=("-PmiE2eeOllvmClangxx=${MI_E2EE_OLLVM_CLANGXX}")
          fi
          ./gradlew :app:assembleRelease -PmiE2eeOpaque=false "${OLLVM_ARGS[@]}" --no-daemon

      - name: Upload Android debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_android_debug
          path: android/app/build/outputs/apk/debug/*.apk

      - name: Upload Android release artifact
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_android_release
          path: android/app/build/outputs/apk/release/*.apk
