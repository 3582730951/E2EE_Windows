name: ci

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-package:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Qt
        id: qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.10.1
          arch: win64_msvc2022_64
          modules: qtmultimedia
          archives: qtbase qtdeclarative qtsvg qttools qttranslations
          cache: true
          use-official: true

      - name: Fetch MySQL client
        run: |
          $vcpkgRoot = Join-Path $env:GITHUB_WORKSPACE "vcpkg"
          if (-not (Test-Path $vcpkgRoot)) {
            git clone https://github.com/microsoft/vcpkg $vcpkgRoot
          }
          & "$vcpkgRoot\\bootstrap-vcpkg.bat"
          & "$vcpkgRoot\\vcpkg.exe" install libmariadb:x64-windows
          $mysqlRoot = Join-Path $vcpkgRoot "installed\\x64-windows"
          $mysqlIncludeRoot = Join-Path $mysqlRoot "include"
          $mysqlInclude = $mysqlIncludeRoot
          if (Test-Path (Join-Path $mysqlIncludeRoot "mysql\\mysql.h")) {
            $mysqlInclude = Join-Path $mysqlIncludeRoot "mysql"
          } elseif (Test-Path (Join-Path $mysqlIncludeRoot "mysql.h")) {
            $mysqlInclude = $mysqlIncludeRoot
          }
          $libCandidates = @(
            (Join-Path $mysqlRoot "lib\\libmariadb.lib")
            (Join-Path $mysqlRoot "lib\\mariadb.lib")
            (Join-Path $mysqlRoot "lib\\libmysql.lib")
            (Join-Path $mysqlRoot "lib\\mysqlclient.lib")
          )
          $mysqlLib = $libCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $mysqlLib) {
            throw "MySQL client lib not found under $mysqlRoot"
          }
          "MYSQL_INCLUDE_DIR=$mysqlInclude" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "MYSQL_CLIENT_LIB=$mysqlLib" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Fetch Rime runtime
        run: |
          $rimeDir = Join-Path $env:GITHUB_WORKSPACE "build\\rime_runtime"
          New-Item -ItemType Directory -Force -Path $rimeDir | Out-Null
          cmake -DRIME_OUTPUT_DIR=$rimeDir -DRIME_WITH_LUA=ON -DRIME_VERSION=1.15.0 -DRIME_ASSET="rime-75bc43a-Windows-msvc-x64.7z" -DRIME_WEASEL_VERSION=0.17.4 -DRIME_WEASEL_ASSET="weasel-0.17.4.0-installer.exe" -P $env:GITHUB_WORKSPACE\\client\\ui\\ime_rime\\FetchRime.cmake
          "RIME_RUNTIME_DIR=$rimeDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Configure client
        run: >
          cmake -S client -B build/client
          -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR"
          -DMI_E2EE_BUILD_UI=ON
          -DMI_E2EE_BUILD_DEMO_CLIENT=ON
          -DMI_E2EE_BUILD_FUZZERS=OFF
          -DMI_E2EE_ENABLE_MYSQL=OFF
          -DMI_UI_RIME_DOWNLOAD=OFF
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build client
        run: cmake --build build/client --config Release --target mi_e2ee_client mi_e2ee_client_ui_app mi_e2ee_client_ui mi_e2ee_launcher mi_ime_rime

      - name: Configure server
        run: >
          cmake -S server -B build/server
          -DMI_E2EE_ENABLE_MYSQL=ON
          -DMYSQL_INCLUDE_DIR="${{ env.MYSQL_INCLUDE_DIR }}"
          -DMYSQL_CLIENT_LIB="${{ env.MYSQL_CLIENT_LIB }}"
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build server
        run: cmake --build build/server --config Release --target mi_e2ee_server mi_e2ee_server_launcher mi_e2ee_kt_keygen mi_e2ee_kt_pubinfo mi_e2ee_perf_baseline mi_e2ee_ops_health_view

      - name: Perf baseline
        run: .\\build\\server\\tools\\Release\\mi_e2ee_perf_baseline.exe --quick

      - name: Deploy Qt runtime
        run: |
          $qtRoot = "${{ steps.qt.outputs.qt-path }}"
          if (-not $qtRoot) {
            $qtRoot = $env:QT_ROOT_DIR
          }
          if (-not $qtRoot) {
            throw "Qt root dir not found"
          }
          $qtBin = Join-Path $qtRoot "bin"
          & (Join-Path $qtBin "windeployqt.exe") --release --compiler-runtime --qmldir $env:GITHUB_WORKSPACE\\client\\ui $env:GITHUB_WORKSPACE\\build\\client\\ui\\Release\\mi_e2ee_client_ui_app.exe
          $uiRoot = Join-Path $env:GITHUB_WORKSPACE "build\\client\\ui\\Release"
          $qmlRoot = Join-Path $uiRoot "qml"
          $qtQmlCoreDll = Join-Path $qtBin "Qt6QmlCore.dll"
          if (Test-Path $qtQmlCoreDll) {
            Copy-Item $qtQmlCoreDll $uiRoot -Force
          }
          $qtQmlCoreModule = Join-Path $qtRoot "qml\\QtCore"
          $dstQmlCoreModule = Join-Path $qmlRoot "QtCore"
          if ((Test-Path $qtQmlCoreModule) -and (-not (Test-Path $dstQmlCoreModule))) {
            New-Item -ItemType Directory -Force -Path $qmlRoot | Out-Null
            Copy-Item $qtQmlCoreModule $dstQmlCoreModule -Recurse -Force
          }

      - name: Package artifacts
        run: |
          $workspace = $env:GITHUB_WORKSPACE
          $distRoot = Join-Path $workspace "dist"
          $clientRoot = Join-Path $distRoot "mi_e2ee_client"
          $serverRoot = Join-Path $distRoot "mi_e2ee_server"
          $clientDll = Join-Path $clientRoot "dll"
          $clientConfig = Join-Path $clientRoot "config"
          $clientDb = Join-Path $clientRoot "database"
          $serverDll = Join-Path $serverRoot "dll"
          $serverConfig = Join-Path $serverRoot "config"
          $serverDb = Join-Path $serverRoot "database"
          New-Item -ItemType Directory -Force -Path $clientDll, $clientConfig, $clientDb, $serverDll, $serverConfig, $serverDb | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $serverDb "offline_store") | Out-Null

          $keysDir = Join-Path $distRoot "keys"
          New-Item -ItemType Directory -Force -Path $keysDir | Out-Null
          & "$workspace\\build\\server\\tools\\Release\\mi_e2ee_kt_keygen.exe" --out-dir $keysDir --force

          $pfxPath = Join-Path $keysDir "mi_e2ee_server.pfx"
          $cert = New-SelfSignedCertificate -DnsName "MI_E2EE_Server" -CertStoreLocation "Cert:\\CurrentUser\\My"
          $pwd = New-Object System.Security.SecureString
          Export-PfxCertificate -Cert $cert -FilePath $pfxPath -Password $pwd | Out-Null
          $cert = Get-PfxCertificate -FilePath $pfxPath
          $der = $cert.Export("Cert")
          $hash = [System.BitConverter]::ToString([System.Security.Cryptography.SHA256]::Create().ComputeHash($der)).Replace("-", "").ToLower()

          Copy-Item "$workspace\\build\\server\\Release\\mi_e2ee_server.exe" (Join-Path $serverRoot "mi_e2ee_server_app.exe") -Force
          Copy-Item "$workspace\\build\\server\\Release\\mi_e2ee_server_launcher.exe" (Join-Path $serverRoot "mi_e2ee_server.exe") -Force
          Copy-Item "$workspace\\build\\server\\Release\\*.dll" $serverDll -Force
          $crtNames = @(
            "concrt140.dll",
            "msvcp140.dll",
            "msvcp140_1.dll",
            "msvcp140_2.dll",
            "msvcp140_atomic_wait.dll",
            "msvcp140_codecvt_ids.dll",
            "vcruntime140.dll",
            "vcruntime140_1.dll",
            "vcruntime140_threads.dll",
            "vccorlib140.dll"
          )
          foreach ($name in $crtNames) {
            $src = Join-Path $serverDll $name
            if (Test-Path $src) {
              Copy-Item $src $serverRoot -Force
            }
          }
          Copy-Item "$workspace\\tools\\mi_e2ee_harden_acl.cmd" (Join-Path $serverRoot "mi_e2ee_harden_acl.cmd") -Force
          if (Test-Path "$workspace\\build\\server\\Release\\test_user.txt") {
            Copy-Item "$workspace\\build\\server\\Release\\test_user.txt" $serverRoot -Force
          }
          $serverTools = Join-Path $serverRoot "tools"
          New-Item -ItemType Directory -Force -Path $serverTools | Out-Null
          Copy-Item "$workspace\\build\\server\\tools\\Release\\mi_e2ee_kt_keygen.exe" $serverTools -Force
          Copy-Item "$workspace\\build\\server\\tools\\Release\\mi_e2ee_kt_pubinfo.exe" $serverTools -Force
          Copy-Item "$workspace\\build\\server\\tools\\Release\\mi_e2ee_perf_baseline.exe" $serverTools -Force
          Copy-Item "$workspace\\build\\server\\tools\\Release\\mi_e2ee_ops_health_view.exe" $serverTools -Force

          Copy-Item "$keysDir\\kt_signing_key.bin" $serverConfig -Force
          Copy-Item "$keysDir\\kt_root_pub.bin" $serverConfig -Force
          Copy-Item $pfxPath $serverConfig -Force

          Copy-Item "$keysDir\\kt_root_pub.bin" $clientConfig -Force

          $serverConfigLines = @(
            "[mode]",
            "mode=0",
            "[mysql]",
            "mysql_ip=localhost",
            "mysql_port=3306",
            "mysql_database=mi_e2ee",
            "mysql_username=root",
            "mysql_password=123456",
            "[server]",
            "list_port=9000",
            "rotation_threshold=10000",
            "offline_dir=database/offline_store",
            "debug_log=0",
            "tls_enable=1",
            "require_tls=1",
            "tls_cert=config/mi_e2ee_server.pfx",
            "kt_signing_key=kt_signing_key.bin"
          )
          $serverConfigLines | Set-Content -Path (Join-Path $serverConfig "config.ini") -Encoding ASCII

          $clientConfigLines = @(
            "[client]",
            "server_ip=127.0.0.1",
            "server_port=9000",
            "use_tls=1",
            "require_tls=1",
            "trust_store=server_trust.ini",
            "require_pinned_fingerprint=1",
            "pinned_fingerprint=$hash",
            "auth_mode=opaque",
            "",
            "[proxy]",
            "type=none",
            "host=",
            "port=0",
            "username=",
            "password=",
            "",
            "[device_sync]",
            "enabled=0",
            "role=primary",
            "key_path=e2ee_state/device_sync_key.bin",
            "",
            "[kt]",
            "require_signature=1",
            "root_pubkey_path=kt_root_pub.bin"
          )
          $clientConfigLines | Set-Content -Path (Join-Path $clientConfig "client_config.ini") -Encoding ASCII

          "" | Set-Content -Path (Join-Path $clientDb "server_trust.ini") -Encoding ASCII

          Copy-Item "$workspace\\build\\client\\ui\\Release\\mi_e2ee_client_ui_app.exe" $clientRoot -Force
          Copy-Item "$workspace\\build\\client\\ui\\Release\\mi_e2ee_client_ui.exe" $clientRoot -Force
          Copy-Item "$workspace\\build\\client\\ui\\Release\\mi_e2ee.exe" $clientRoot -Force

          $uiRoot = Join-Path $workspace "build\\client\\ui\\Release"
          $uiRcc = Join-Path $uiRoot "ui_resources.rcc"
          if (Test-Path $uiRcc) {
            Copy-Item $uiRcc (Join-Path $clientDll "ui_resources.rcc") -Force
          }
          Get-ChildItem -Path $uiRoot -File -Filter "*.dll" |
            Where-Object { $_.Name -notlike "qmldbg_*" } | ForEach-Object {
              Copy-Item $_.FullName $clientDll -Force
            }
          $rimeRuntime = $env:RIME_RUNTIME_DIR
          if (-not $rimeRuntime) {
            $rimeRuntime = Join-Path $workspace "build\\rime_runtime"
          }
          if (Test-Path (Join-Path $rimeRuntime "rime.dll")) {
            Copy-Item (Join-Path $rimeRuntime "rime.dll") $clientDll -Force
          }
          if (Test-Path (Join-Path $rimeRuntime "opencc")) {
            Copy-Item (Join-Path $rimeRuntime "opencc") (Join-Path $clientDb "opencc") -Recurse -Force
          }
          $skipDirs = @("qml", "translations", "icon", "assets", "runtime", "qmltooling")
          Get-ChildItem -Path $uiRoot -Directory | Where-Object { $skipDirs -notcontains $_.Name } | ForEach-Object {
            Copy-Item $_.FullName $clientDll -Recurse -Force
          }
          if (Test-Path (Join-Path $uiRoot "qml")) {
            Copy-Item (Join-Path $uiRoot "qml") (Join-Path $clientDll "qml") -Recurse -Force
          }
          if (Test-Path (Join-Path $uiRoot "translations")) {
            Copy-Item (Join-Path $uiRoot "translations") (Join-Path $clientRoot "translations") -Recurse -Force
          }
          if (Test-Path (Join-Path $uiRoot "icon")) {
            Copy-Item (Join-Path $uiRoot "icon") (Join-Path $clientRoot "icon") -Recurse -Force
          }
          if (Test-Path (Join-Path $uiRoot "assets")) {
            Copy-Item (Join-Path $uiRoot "assets") (Join-Path $clientRoot "assets") -Recurse -Force
          }
          $sourceIcons = Join-Path $workspace "client\\ui\\icons"
          if (Test-Path $sourceIcons) {
            Copy-Item $sourceIcons (Join-Path $clientRoot "icon") -Recurse -Force
          }
          $sourceRef = Join-Path $workspace "client\\assets\\ref"
          if (Test-Path $sourceRef) {
            Copy-Item $sourceRef (Join-Path $clientRoot "assets\\ref") -Recurse -Force
          }
          if (Test-Path (Join-Path $uiRoot "runtime")) {
            $runtimeRoot = Join-Path $uiRoot "runtime"
            Get-ChildItem -Path $runtimeRoot -File | ForEach-Object {
              if ($_.Extension -ieq ".dll" -and $_.Name -notlike "qmldbg_*") {
                Copy-Item $_.FullName $clientDll -Force
              } else {
                Copy-Item $_.FullName $clientDb -Force
              }
            }
            Get-ChildItem -Path $runtimeRoot -Directory | ForEach-Object {
              Copy-Item $_.FullName (Join-Path $clientDb $_.Name) -Recurse -Force
            }
          }
          $imeRoot = Join-Path $workspace "build\\client\\ui\\ime_rime\\Release"
          $imeCandidates = @(
            (Join-Path $workspace "build\\client\\ui\\Release\\mi_ime_rime.dll"),
            (Join-Path $workspace "build\\client\\ui\\Release\\runtime\\mi_ime_rime.dll"),
            (Join-Path $workspace "build\\client\\ui\\ime_rime\\Release\\mi_ime_rime.dll"),
            (Join-Path $workspace "build\\client\\ime_rime\\Release\\mi_ime_rime.dll")
          )
          $imeDllPath = $imeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $imeDllPath) {
            $imeDllPath = Get-ChildItem -Path (Join-Path $workspace "build\\client") -Recurse -Filter "mi_ime_rime.dll" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($imeDllPath) {
              $imeDllPath = $imeDllPath.FullName
            }
          }
          if ($imeDllPath) {
            Copy-Item $imeDllPath $clientDll -Force
            Copy-Item $imeDllPath $clientRoot -Force
          }
          $rimeDllPath = $null
          $rimeCandidates = @(
            (Join-Path $imeRoot "rime.dll"),
            (Join-Path $workspace "build\\client\\ui\\Release\\runtime\\rime.dll")
          )
          $rimeDllPath = $rimeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if ($rimeDllPath) {
            Copy-Item $rimeDllPath $clientDll -Force
          }
          if (Test-Path (Join-Path $imeRoot "opencc")) {
            Copy-Item (Join-Path $imeRoot "opencc") (Join-Path $clientDb "opencc") -Recurse -Force
          }
          Get-ChildItem -Path $clientRoot -Recurse -Filter "qmldbg_*.dll" | Remove-Item -Force

          $clientZip = Join-Path $distRoot "mi_e2ee_client.zip"
          $serverZip = Join-Path $distRoot "mi_e2ee_server.zip"
          Compress-Archive -Path $clientRoot -DestinationPath $clientZip -Force
          Compress-Archive -Path $serverRoot -DestinationPath $serverZip -Force

      - name: Perf baseline (dist)
        run: .\\dist\\mi_e2ee_server\\tools\\mi_e2ee_perf_baseline.exe --quick

      - name: Upload client package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_client
          path: dist/mi_e2ee_client.zip

      - name: Upload server package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_server
          path: dist/mi_e2ee_server.zip
