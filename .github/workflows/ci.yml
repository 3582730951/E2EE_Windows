name: Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release

jobs:
  server-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [demo, mysql]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake libmysqlclient-dev

      - name: Configure server
        run: |
          cmake -S server -B build/server-${{ matrix.mode }} \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            $([ "${{ matrix.mode }}" = "mysql" ] && echo "-DMI_E2EE_ENABLE_MYSQL=ON")

      - name: Build server
        run: cmake --build build/server-${{ matrix.mode }}

      - name: Test server
        run: ctest --output-on-failure --test-dir build/server-${{ matrix.mode }}

      - name: Package server
        run: |
          mkdir -p artifacts/server-${{ matrix.mode }}
          cp build/server-${{ matrix.mode }}/mi_e2ee_server artifacts/server-${{ matrix.mode }}/
          cp server/config.example.ini artifacts/server-${{ matrix.mode }}/config.example.ini
          tar -czf server-${{ matrix.mode }}-${{ env.BUILD_TYPE }}.tar.gz -C artifacts server-${{ matrix.mode }}

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.mode }}-${{ env.BUILD_TYPE }}
          path: server-${{ matrix.mode }}-${{ env.BUILD_TYPE }}.tar.gz

  client-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y ninja cmake

      - name: Install Qt (MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          dir: 'C:\\Qt'
          modules: 'qtsvg qttools qtimageformats'
          use-official: true
          cache: true

      - name: Add Qt to PATH
        run: |
          $qtRoot = "$Env:QT_ROOT_DIR"
          $qtBin = Join-Path $qtRoot "bin"
          Add-Content -Path $Env:GITHUB_PATH -Value $qtBin

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure client (UI on)
        run: |
          cmake -G "Ninja" -S client -B build/client -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DMI_E2EE_BUILD_UI=ON -DCMAKE_PREFIX_PATH="$Env:QT_ROOT_DIR"

      - name: Build client
        run: cmake --build build/client

      - name: Deploy Qt runtime
        run: |
          $qtbin = Join-Path "$Env:QT_ROOT_DIR" "bin"
          & "$qtbin/windeployqt.exe" --qmldir client/ui/qml build/client/ui/mi_e2ee_client_ui.exe

      - name: Package client UI
        run: |
          New-Item -ItemType Directory -Force artifacts/client-ui | Out-Null
          Copy-Item build/client/ui/mi_e2ee_client_ui.exe artifacts/client-ui/
          Copy-Item build/client/ui/*.dll artifacts/client-ui/ -ErrorAction SilentlyContinue
          Copy-Item build/client/ui/qt artifacts/client-ui/qt -Recurse -ErrorAction SilentlyContinue
          # 包含 windeploy 输出的 Qt QML 依赖和源 QML
          Copy-Item build/client/ui/qml artifacts/client-ui/qml -Recurse -ErrorAction SilentlyContinue
          Copy-Item client/ui/qml/* artifacts/client-ui/qml/ -Recurse -Force
          Copy-Item "$Env:QT_ROOT_DIR/qml/*" artifacts/client-ui/qml/ -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/client/ui/platforms artifacts/client-ui/platforms -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/client/ui/imageformats artifacts/client-ui/imageformats -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/client/ui/iconengines artifacts/client-ui/iconengines -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/client/ui/networkinformation artifacts/client-ui/networkinformation -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/client/ui/tls artifacts/client-ui/tls -Recurse -ErrorAction SilentlyContinue
          Copy-Item build/client/ui/generic artifacts/client-ui/generic -Recurse -ErrorAction SilentlyContinue
          Compress-Archive -Path artifacts/client-ui/* -DestinationPath client-ui-${{ env.BUILD_TYPE }}.zip

      - name: Upload client UI artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-ui-${{ env.BUILD_TYPE }}
          path: client-ui-${{ env.BUILD_TYPE }}.zip
