name: Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  BUILD_TYPE: Release

jobs:
  server-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mode: [demo, mysql]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake libmysqlclient-dev

      - name: Configure server
        run: |
          cmake -S server -B build/server-${{ matrix.mode }} \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            $([ "${{ matrix.mode }}" = "mysql" ] && echo "-DMI_E2EE_ENABLE_MYSQL=ON")

      - name: Build server
        run: cmake --build build/server-${{ matrix.mode }}

      - name: Test server
        run: ctest --output-on-failure --test-dir build/server-${{ matrix.mode }}

      - name: Package server
        run: |
          mkdir -p artifacts/server-${{ matrix.mode }}
          cp build/server-${{ matrix.mode }}/mi_e2ee_server artifacts/server-${{ matrix.mode }}/
          cp server/config.example.ini artifacts/server-${{ matrix.mode }}/config.example.ini
          cp build/server-${{ matrix.mode }}/test_user.txt artifacts/server-${{ matrix.mode }}/test_user.txt
          tar -czf server-${{ matrix.mode }}-${{ env.BUILD_TYPE }}.tar.gz -C artifacts server-${{ matrix.mode }}

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.mode }}-${{ env.BUILD_TYPE }}
          path: server-${{ matrix.mode }}-${{ env.BUILD_TYPE }}.tar.gz

  server-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y ninja cmake

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure server (Release, TCP on, no MySQL)
        run: |
          cmake -G "Ninja" -S server -B build/server-win -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DMI_E2EE_ENABLE_MYSQL=OFF -DMI_E2EE_ENABLE_TCP_SERVER=ON

      - name: Build server
        run: cmake --build build/server-win

      - name: Package server (Windows)
        run: |
          New-Item -ItemType Directory -Force artifacts/server-win | Out-Null
          Copy-Item build/server-win/mi_e2ee_server.exe artifacts/server-win/
          Copy-Item build/server-win/*.dll artifacts/server-win/ -ErrorAction SilentlyContinue
          @"
          [mode]
          mode=1  # 0=mysql, 1=demo
          [mysql]
          mysql_ip=
          mysql_port=
          mysql_database=
          mysql_username=
          mysql_password=
          [server]
          list_port=9000
          rotation_threshold=10000
          offline_dir=offline_store
          debug_log=0
          "@ | Set-Content -Encoding ASCII artifacts/server-win/config.ini
          Copy-Item build/server-win/test_user.txt artifacts/server-win/test_user.txt -ErrorAction Stop
          Compress-Archive -Path artifacts/server-win/* -DestinationPath server-win-${{ env.BUILD_TYPE }}.zip

      - name: Upload server-windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-windows-${{ env.BUILD_TYPE }}
          path: server-win-${{ env.BUILD_TYPE }}.zip

  client-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Install build tools
        shell: pwsh
        run: |
          choco install -y ninja cmake

      - name: Install Qt (MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          dir: 'C:\\Qt'
          use-official: true
          cache: true

      - name: Add Qt to PATH
        run: |
          $qtRoot = "$Env:QT_ROOT_DIR"
          $qtBin = Join-Path $qtRoot "bin"
          Add-Content -Path $Env:GITHUB_PATH -Value $qtBin

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure client (UI on)
        run: |
          cmake -G "Ninja" -S client -B build/client -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DMI_E2EE_BUILD_UI=ON -DCMAKE_PREFIX_PATH="$Env:QT_ROOT_DIR"

      - name: Build client
        run: cmake --build build/client

      - name: Deploy Qt runtime
        run: |
          $qtbin = Join-Path "$Env:QT_ROOT_DIR" "bin"
          $exe = "build/client/ui/qq_main_list/qq_main_list.exe"
          $exeDir = Split-Path -Parent $exe
          $dist = "build/client/ui/dist"
          if (!(Test-Path $exe)) {
            Write-Error "main ui exe not found at $exe"
            exit 1
          }
          New-Item -ItemType Directory -Force $dist | Out-Null
          Copy-Item $exe (Join-Path $dist "mi_e2ee.exe") -Force
          # Bundle MSVC runtime next to the executable to avoid loading an older system CRT.
          if (Test-Path $exeDir) {
            Copy-Item "$exeDir/*.dll" $dist -Force -ErrorAction SilentlyContinue
          }
          & "$qtbin/windeployqt.exe" "--dir" $dist (Join-Path $dist "mi_e2ee.exe")
          $iconSrc = "client/ui/icons"
          if (Test-Path $iconSrc) {
            Copy-Item "$iconSrc/*.svg" $dist -Force -ErrorAction SilentlyContinue
          }
          @"
          [client]
          server_ip=127.0.0.1
          server_port=9000
          use_tls=1
          trust_store=server_trust.ini
          "@ | Set-Content -Encoding ASCII (Join-Path $dist "client_config.ini")
          Copy-Item (Join-Path $dist "client_config.ini") (Join-Path $dist "config.ini") -Force

      - name: Package client UI
        run: |
          Compress-Archive -Path build/client/ui/dist/* -DestinationPath client-ui-${{ env.BUILD_TYPE }}.zip

      - name: Upload client UI artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-ui-${{ env.BUILD_TYPE }}
          path: client-ui-${{ env.BUILD_TYPE }}.zip
