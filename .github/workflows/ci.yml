name: ci

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-test:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Configure server
        run: >
          cmake -S server -B build/server
          -DMI_E2EE_ENABLE_MYSQL=OFF
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build server
        run: cmake --build build/server --config Release

      - name: Test server
        run: ctest -C Release --test-dir build/server --output-on-failure

      - name: Configure client
        run: >
          cmake -S client -B build/client
          -DMI_E2EE_ENABLE_MYSQL=OFF
          -DMI_E2EE_BUILD_UI=OFF
          -DMI_E2EE_BUILD_DEMO_CLIENT=ON
          -DMI_E2EE_BUILD_FUZZERS=ON
          -DMI_E2EE_FUZZ_SMOKE=ON
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build client
        run: cmake --build build/client --config Release

      - name: Test client
        run: ctest -C Release --test-dir build/client --output-on-failure
