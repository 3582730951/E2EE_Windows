name: ci

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-package:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Qt
        id: qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.10.1
          arch: win64_msvc2022_64
          modules: qtmultimedia qtpositioning
          archives: qtbase qtdeclarative qtsvg qttools qttranslations
          cache: true
          use-official: true

      - name: Fetch MySQL client
        run: |
          $vcpkgRoot = Join-Path $env:GITHUB_WORKSPACE "vcpkg"
          if (-not (Test-Path $vcpkgRoot)) {
            git clone https://github.com/microsoft/vcpkg $vcpkgRoot
          }
          & "$vcpkgRoot\\bootstrap-vcpkg.bat"
          & "$vcpkgRoot\\vcpkg.exe" install libmariadb:x64-windows
          $mysqlRoot = Join-Path $vcpkgRoot "installed\\x64-windows"
          $mysqlIncludeRoot = Join-Path $mysqlRoot "include"
          $mysqlInclude = $mysqlIncludeRoot
          if (Test-Path (Join-Path $mysqlIncludeRoot "mysql\\mysql.h")) {
            $mysqlInclude = Join-Path $mysqlIncludeRoot "mysql"
          } elseif (Test-Path (Join-Path $mysqlIncludeRoot "mysql.h")) {
            $mysqlInclude = $mysqlIncludeRoot
          }
          $libCandidates = @(
            (Join-Path $mysqlRoot "lib\\libmariadb.lib")
            (Join-Path $mysqlRoot "lib\\mariadb.lib")
            (Join-Path $mysqlRoot "lib\\libmysql.lib")
            (Join-Path $mysqlRoot "lib\\mysqlclient.lib")
          )
          $mysqlLib = $libCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $mysqlLib) {
            throw "MySQL client lib not found under $mysqlRoot"
          }
          "MYSQL_INCLUDE_DIR=$mysqlInclude" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "MYSQL_CLIENT_LIB=$mysqlLib" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Fetch Rime runtime
        run: |
          $rimeDir = Join-Path $env:GITHUB_WORKSPACE "build\\rime_runtime"
          New-Item -ItemType Directory -Force -Path $rimeDir | Out-Null
          $fetchArgs = @(
            "-DRIME_OUTPUT_DIR=$rimeDir",
            "-DRIME_WITH_LUA=ON",
            "-DRIME_VERSION=1.15.0",
            "-DRIME_ASSET=rime-75bc43a-Windows-msvc-x64.7z",
            "-DRIME_WEASEL_VERSION=0.17.4",
            "-DRIME_WEASEL_ASSET=weasel-0.17.4.0-installer.exe",
            "-P",
            "$env:GITHUB_WORKSPACE\\client\\ui\\ime_rime\\FetchRime.cmake"
          )
          cmake @fetchArgs
          $rimeCandidates = @(
            (Join-Path $rimeDir "rime.dll"),
            (Join-Path $rimeDir "librime.dll")
          )
          $rimeDll = $rimeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $rimeDll) {
            $fallbackArgs = @(
              "-DRIME_OUTPUT_DIR=$rimeDir",
              "-DRIME_WITH_LUA=OFF",
              "-DRIME_VERSION=1.15.0",
              "-DRIME_ASSET=rime-75bc43a-Windows-msvc-x64.7z",
              "-P",
              "$env:GITHUB_WORKSPACE\\client\\ui\\ime_rime\\FetchRime.cmake"
            )
            cmake @fallbackArgs
            $rimeDll = $rimeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
          }
          if (-not $rimeDll) {
            throw "rime runtime dll not found after FetchRime.cmake"
          }
          if (-not (Test-Path (Join-Path $rimeDir "rime.dll"))) {
            Copy-Item $rimeDll (Join-Path $rimeDir "rime.dll") -Force
          }
          "RIME_RUNTIME_DIR=$rimeDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Fetch FFmpeg runtime
        run: |
          $ffmpegRoot = Join-Path $env:GITHUB_WORKSPACE "build\\ffmpeg"
          New-Item -ItemType Directory -Force -Path $ffmpegRoot | Out-Null
          $ffmpegZip = Join-Path $ffmpegRoot "ffmpeg.zip"
          $ffmpegUrl = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegZip
          Expand-Archive -Path $ffmpegZip -DestinationPath $ffmpegRoot -Force
          $ffmpegExe = Get-ChildItem -Path $ffmpegRoot -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          if (-not $ffmpegExe) {
            throw "ffmpeg.exe not found"
          }
          "FFMPEG_RUNTIME_DIR=$($ffmpegExe.Directory.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Fetch Real-ESRGAN runtime
        run: |
          $esrganRoot = Join-Path $env:GITHUB_WORKSPACE "build\\realesrgan"
          New-Item -ItemType Directory -Force -Path $esrganRoot | Out-Null
          $esrganZip = Join-Path $esrganRoot "realesrgan.zip"
          $esrganUrl = "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-windows.zip"
          Invoke-WebRequest -Uri $esrganUrl -OutFile $esrganZip
          Expand-Archive -Path $esrganZip -DestinationPath $esrganRoot -Force
          $esrganExe = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-ncnn-vulkan.exe" | Select-Object -First 1
          if (-not $esrganExe) {
            $esrganExe = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-ncnn.exe" | Select-Object -First 1
          }
          if (-not $esrganExe) {
            throw "realesrgan executable not found"
          }
          $modelParam = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-x4plus.param" | Select-Object -First 1
          $modelBin = Get-ChildItem -Path $esrganRoot -Recurse -Filter "realesrgan-x4plus.bin" | Select-Object -First 1
          if (-not $modelParam -or -not $modelBin) {
            throw "realesrgan model not found"
          }
          $modelDir = $modelParam.Directory.FullName
          $optionalModels = @("realesrgan-x2plus", "realesrgan-x4plus-anime")
          $modelBaseUrl = "https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0"
          foreach ($model in $optionalModels) {
            $paramPath = Join-Path $modelDir "$model.param"
            $binPath = Join-Path $modelDir "$model.bin"
            if (-not (Test-Path $paramPath)) {
              try {
                Invoke-WebRequest -Uri "$modelBaseUrl/$model.param" -OutFile $paramPath -ErrorAction Stop
              } catch {
                Write-Warning "Failed to download $model.param"
              }
            }
            if (-not (Test-Path $binPath)) {
              try {
                Invoke-WebRequest -Uri "$modelBaseUrl/$model.bin" -OutFile $binPath -ErrorAction Stop
              } catch {
                Write-Warning "Failed to download $model.bin"
              }
            }
          }
          "REALESRGAN_RUNTIME_DIR=$($esrganExe.Directory.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "REALESRGAN_MODEL_DIR=$modelDir" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install Python deps
        run: python -m pip install --upgrade pip wordfreq

      - name: Prepare Rime dictionaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $overlayRoot = Join-Path $env:GITHUB_WORKSPACE "build\\rime_overlay"
          python .\\tools\\rime_dict_prepare.py --out $overlayRoot

      - name: Configure client
        run: >
          cmake -S client -B build/client
          -DCMAKE_PREFIX_PATH="$env:QT_ROOT_DIR"
          -DMI_E2EE_BUILD_UI=ON
          -DMI_E2EE_BUILD_DEMO_CLIENT=ON
          -DMI_E2EE_BUILD_FUZZERS=OFF
          -DMI_E2EE_ENABLE_MYSQL=OFF
          -DMI_UI_RIME_DOWNLOAD=OFF
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build rime precompile tool
        run: cmake --build build/client --config Release --target mi_rime_precompile

      - name: Precompile Rime user data
        run: |
          $precompileExe = Get-ChildItem -Path $env:GITHUB_WORKSPACE\\build\\client -Recurse -Filter "mi_rime_precompile.exe" | Select-Object -First 1
          if (-not $precompileExe) {
            throw "mi_rime_precompile.exe not found"
          }
          $prebuiltRoot = Join-Path $env:GITHUB_WORKSPACE "build\\rime_prebuilt"
          New-Item -ItemType Directory -Force -Path $prebuiltRoot | Out-Null
          $runtimeDir = $env:RIME_RUNTIME_DIR
          $overlayDir = Join-Path $env:GITHUB_WORKSPACE "build\\rime_overlay\\share"
          if (-not $runtimeDir) {
            $runtimeDir = Join-Path $env:GITHUB_WORKSPACE "build\\rime_runtime"
          }
          & $precompileExe.FullName --output-dir $prebuiltRoot --runtime-dir $runtimeDir --overlay-dir $overlayDir

      - name: Verify Rime dictionaries
        run: |
          $prebuilt = Join-Path $env:GITHUB_WORKSPACE "build\\rime_prebuilt\\user"
          if (-not (Test-Path $prebuilt)) {
            throw "rime prebuilt not found: $prebuilt"
          }
          if (-not (Get-ChildItem -Path $prebuilt -Recurse -File | Select-Object -First 1)) {
            throw "rime prebuilt empty: $prebuilt"
          }
          $share = Join-Path $env:GITHUB_WORKSPACE "build\\rime_overlay\\share"
          if (-not (Test-Path $share)) {
            throw "rime overlay share not found: $share"
          }
          if (-not (Get-ChildItem -Path $share -Recurse -File | Select-Object -First 1)) {
            throw "rime overlay share empty: $share"
          }

      - name: Build client
        run: cmake --build build/client --config Release --target mi_e2ee_client mi_e2ee_client_ui_app mi_e2ee_client_ui mi_e2ee_launcher mi_ime_rime mi_e2ee_client_sdk

      - name: Build Rust bindings
        run: |
          $env:MI_E2EE_CLIENT_LIB_DIR = Join-Path $env:GITHUB_WORKSPACE "build\\client\\Release"
          cargo build --manifest-path bindings/rust/Cargo.toml --examples

      - name: Python binding smoke
        run: |
          $env:MI_E2EE_CLIENT_DLL = Join-Path $env:GITHUB_WORKSPACE "build\\client\\Release\\mi_e2ee_client_sdk.dll"
          python bindings\\python\\example_basic.py

      - name: Configure server
        run: >
          cmake -S server -B build/server
          -DMI_E2EE_ENABLE_MYSQL=ON
          -DMYSQL_INCLUDE_DIR="${{ env.MYSQL_INCLUDE_DIR }}"
          -DMYSQL_CLIENT_LIB="${{ env.MYSQL_CLIENT_LIB }}"
          -DMI_E2EE_PGO_INSTRUMENT=OFF
          -DMI_E2EE_ENABLE_LTO=OFF

      - name: Build server
        run: cmake --build build/server --config Release --target mi_e2ee_server mi_e2ee_server_launcher mi_e2ee_kt_keygen mi_e2ee_kt_pubinfo mi_e2ee_perf_baseline mi_e2ee_ops_health_view mi_e2ee_third_party_audit

      - name: Perf baseline
        run: .\\build\\server\\tools\\Release\\mi_e2ee_perf_baseline.exe --quick

      - name: Deploy Qt runtime
        run: |
          $qtRoot = "${{ steps.qt.outputs.qt-path }}"
          if (-not $qtRoot) {
            $qtRoot = $env:QT_ROOT_DIR
          }
          if (-not $qtRoot) {
            throw "Qt root dir not found"
          }
          $qtBin = Join-Path $qtRoot "bin"
          & (Join-Path $qtBin "windeployqt.exe") --release --compiler-runtime --qmldir $env:GITHUB_WORKSPACE\\client\\ui $env:GITHUB_WORKSPACE\\build\\client\\ui\\Release\\mi_e2ee_client_ui_app.exe
          $uiRoot = Join-Path $env:GITHUB_WORKSPACE "build\\client\\ui\\Release"
          $qmlRoot = Join-Path $uiRoot "qml"
          $qtQmlCoreDll = Join-Path $qtBin "Qt6QmlCore.dll"
          if (Test-Path $qtQmlCoreDll) {
            Copy-Item $qtQmlCoreDll $uiRoot -Force
          }
          $qtQmlCoreModule = Join-Path $qtRoot "qml\\QtCore"
          $dstQmlCoreModule = Join-Path $qmlRoot "QtCore"
          if ((Test-Path $qtQmlCoreModule) -and (-not (Test-Path $dstQmlCoreModule))) {
            New-Item -ItemType Directory -Force -Path $qmlRoot | Out-Null
            Copy-Item $qtQmlCoreModule $dstQmlCoreModule -Recurse -Force
          }

      - name: Package artifacts
        run: .\\tools\\package_windows.ps1

      - name: Verify package
        run: .\\tools\\verify_package_windows.ps1

      - name: Perf baseline (dist)
        run: .\\dist\\mi_e2ee_server\\tools\\mi_e2ee_perf_baseline.exe --quick

      - name: Upload client package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_client
          path: dist/mi_e2ee_client.zip

      - name: Upload server package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_server
          path: dist/mi_e2ee_server.zip

  build-linux:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Install OpenSSL
        run: sudo apt-get update && sudo apt-get install -y libssl-dev libsecret-1-dev pkg-config openssl

      - name: Configure server
        run: cmake -S server -B build/server -DMI_E2EE_ENABLE_MYSQL=OFF

      - name: Build server
        run: cmake --build build/server --config Release --target mi_e2ee_server mi_e2ee_kt_keygen mi_e2ee_kt_pubinfo mi_e2ee_perf_baseline mi_e2ee_ops_health_view mi_e2ee_third_party_audit

      - name: Configure client
        run: cmake -S client -B build/client -DMI_E2EE_BUILD_UI=OFF -DMI_E2EE_BUILD_DEMO_CLIENT=OFF -DMI_E2EE_ENABLE_MYSQL=OFF

      - name: Build client core
        run: cmake --build build/client --config Release --target mi_e2ee_client_core mi_e2ee_client_sdk

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust bindings
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: cargo build --manifest-path bindings/rust/Cargo.toml --examples

      - name: Python binding smoke
        env:
          MI_E2EE_CLIENT_DLL: ${{ github.workspace }}/build/client/libmi_e2ee_client_sdk.so
        run: python bindings/python/example_basic.py

      - name: Package artifacts
        run: bash tools/package_posix.sh --platform linux

      - name: Verify package
        run: bash tools/verify_package_posix.sh --platform linux

      - name: Upload client package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_client_linux
          path: dist/mi_e2ee_client_linux.tar.gz

      - name: Upload server package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_server_linux
          path: dist/mi_e2ee_server_linux.tar.gz

  build-macos:
    runs-on: macos-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Install OpenSSL
        run: brew install openssl@3 pkg-config

      - name: Configure server
        run: cmake -S server -B build/server -DMI_E2EE_ENABLE_MYSQL=OFF -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)

      - name: Build server
        run: cmake --build build/server --config Release --target mi_e2ee_server mi_e2ee_kt_keygen mi_e2ee_kt_pubinfo mi_e2ee_perf_baseline mi_e2ee_ops_health_view mi_e2ee_third_party_audit

      - name: Configure client
        run: cmake -S client -B build/client -DMI_E2EE_BUILD_UI=OFF -DMI_E2EE_BUILD_DEMO_CLIENT=OFF -DMI_E2EE_ENABLE_MYSQL=OFF -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)

      - name: Build client core
        run: cmake --build build/client --config Release --target mi_e2ee_client_core mi_e2ee_client_sdk

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust bindings
        env:
          MI_E2EE_CLIENT_LIB_DIR: ${{ github.workspace }}/build/client
        run: cargo build --manifest-path bindings/rust/Cargo.toml --examples

      - name: Python binding smoke
        env:
          MI_E2EE_CLIENT_DLL: ${{ github.workspace }}/build/client/libmi_e2ee_client_sdk.dylib
        run: python bindings/python/example_basic.py

      - name: Package artifacts
        run: bash tools/package_posix.sh --platform macos --openssl "$(brew --prefix openssl@3)/bin/openssl"

      - name: Verify package
        run: bash tools/verify_package_posix.sh --platform macos

      - name: Upload client package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_client_macos
          path: dist/mi_e2ee_client_macos.tar.gz

      - name: Upload server package
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_server_macos
          path: dist/mi_e2ee_server_macos.tar.gz

  build-android:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    env:
      MI_E2EE_ANDROID_OLLVM: ${{ vars.MI_E2EE_ANDROID_OLLVM || '1' }}
      MI_E2EE_OLLVM_URL_TEMPLATE: ${{ vars.MI_E2EE_OLLVM_URL_TEMPLATE || '' }}
      MI_E2EE_ANDROID_NDK_VERSION: ${{ vars.MI_E2EE_ANDROID_NDK_VERSION || '25.2.9519653' }}
      MI_E2EE_OLLVM_FALLBACK_URL: ${{ vars.MI_E2EE_OLLVM_FALLBACK_URL || 'https://github.com/codetronik/ollvm-ndk/releases/download/r23c-release/clang' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init submodules
        run: git submodule update --init --recursive

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install OLLVM host deps
        run: |
          sudo apt-get update
          if ! sudo apt-get install -y libtinfo5 libncurses5 libc++1 libc++abi1; then
            sudo apt-get install -y libtinfo6 libncurses6 libc++1 libc++abi1
          fi

      - name: Install Android components
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "cmake;3.22.1" "ndk;${MI_E2EE_ANDROID_NDK_VERSION}"

      - name: Prepare OLLVM URL
        if: env.MI_E2EE_ANDROID_OLLVM == '1' || env.MI_E2EE_ANDROID_OLLVM == 'true'
        run: |
          set -euo pipefail
          NDK_ROOT="$ANDROID_SDK_ROOT/ndk/$MI_E2EE_ANDROID_NDK_VERSION"
          if [ ! -d "$NDK_ROOT" ]; then
            NDK_ROOT=$(ls -d "$ANDROID_SDK_ROOT/ndk/"* 2>/dev/null | sort -V | tail -n 1)
          fi
          if [ -z "$NDK_ROOT" ]; then
            echo "NDK not found under $ANDROID_SDK_ROOT/ndk" >&2
            exit 1
          fi
          CLANG_BIN="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang"
          if [ ! -x "$CLANG_BIN" ]; then
            echo "clang not found: $CLANG_BIN" >&2
            exit 1
          fi
          LLVM_FULL=$("$CLANG_BIN" --version | head -n 1 | sed -E 's/.*clang version ([0-9]+\\.[0-9]+\\.[0-9]+).*/\\1/')
          if [ -z "$LLVM_FULL" ]; then
            echo "Failed to parse clang version from $CLANG_BIN" >&2
            exit 1
          fi
          LLVM_MAJOR=$(echo "$LLVM_FULL" | cut -d. -f1)
          NDK_REV=$(grep -E '^Pkg.Revision' "$NDK_ROOT/source.properties" | cut -d= -f2 | tr -d ' ')
          URL=""
          if [ -n "${MI_E2EE_OLLVM_URL_TEMPLATE:-}" ]; then
            URL="$MI_E2EE_OLLVM_URL_TEMPLATE"
            URL="${URL//\\{LLVM_FULL\\}/$LLVM_FULL}"
            URL="${URL//\\{LLVM_MAJOR\\}/$LLVM_MAJOR}"
          else
            OLLVM_NDK_TAG=""
            case "$NDK_REV" in
              25.2.*) OLLVM_NDK_TAG="r25c" ;;
              26.*) OLLVM_NDK_TAG="r26d" ;;
              23.2.*) OLLVM_NDK_TAG="r23c" ;;
            esac
            if [ -z "$OLLVM_NDK_TAG" ]; then
              echo "Unsupported NDK revision for default OLLVM mapping: $NDK_REV" >&2
              echo "Set MI_E2EE_OLLVM_URL_TEMPLATE to override." >&2
              exit 1
            fi
            URL="https://github.com/Saint-Theana/ollvm-ndk-android/releases/download/0.0/android-ndk-${OLLVM_NDK_TAG}-linux.tar.gz"
            if ! curl -sfI "$URL" >/dev/null; then
              URL="https://github.com/Saint-Theana/ollvm-ndk-android/releases/download/0.0/android-ndk-${OLLVM_NDK_TAG}-android.tar.gz"
            fi
          fi
          if [ -z "$URL" ]; then
            echo "OLLVM URL is empty" >&2
            exit 1
          fi
          mkdir -p build/ollvm
          echo "$NDK_REV|$LLVM_FULL|$URL" > build/ollvm/cache_key.txt
          echo "NDK_REV=$NDK_REV" >> $GITHUB_ENV
          echo "OLLVM_URL=$URL" >> $GITHUB_ENV

      - name: Cache OLLVM download
        if: env.MI_E2EE_ANDROID_OLLVM == '1' || env.MI_E2EE_ANDROID_OLLVM == 'true'
        uses: actions/cache@v4
        with:
          path: build/ollvm/ollvm.tar.gz
          key: ollvm-${{ runner.os }}-${{ hashFiles('build/ollvm/cache_key.txt') }}

      - name: Fetch OLLVM toolchain
        if: env.MI_E2EE_ANDROID_OLLVM == '1' || env.MI_E2EE_ANDROID_OLLVM == 'true'
        run: |
          set -euo pipefail
          OLLVM_VALID=1
          if [ -z "${OLLVM_URL:-}" ]; then
            echo "OLLVM_URL not set. Falling back to standalone OLLVM clang." >&2
            OLLVM_VALID=0
          else
            echo "Using OLLVM URL: $OLLVM_URL"
            mkdir -p build/ollvm
            if [ ! -f build/ollvm/ollvm.tar.gz ]; then
              curl -L "$OLLVM_URL" -o build/ollvm/ollvm.tar.gz
            fi
            tar -xf build/ollvm/ollvm.tar.gz -C build/ollvm
            OLLVM_NDK_ROOT=$(find build/ollvm -type f -name source.properties -print -quit | xargs -r dirname)
            if [ -z "$OLLVM_NDK_ROOT" ]; then
              echo "OLLVM NDK root not found in build/ollvm" >&2
              OLLVM_VALID=0
            else
              OLLVM_CLANG="$OLLVM_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang"
              OLLVM_CLANGXX="$OLLVM_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++"
              if [ ! -x "$OLLVM_CLANG" ] || [ ! -x "$OLLVM_CLANGXX" ]; then
                echo "OLLVM clang binaries not found in $OLLVM_NDK_ROOT" >&2
                OLLVM_VALID=0
              fi
            fi
          fi
          if [ "$OLLVM_VALID" = "1" ]; then
            if ! "$OLLVM_CLANG" --version >/dev/null 2>&1; then
              echo "OLLVM clang is not runnable on this runner. Falling back." >&2
              OLLVM_VALID=0
            fi
          fi
          if [ "$OLLVM_VALID" = "1" ]; then
            OLLVM_CLANG=$(realpath "$OLLVM_CLANG")
            OLLVM_CLANGXX=$(realpath "$OLLVM_CLANGXX")
            OLLVM_NDK_ROOT=$(realpath "$OLLVM_NDK_ROOT")
            echo "MI_E2EE_OLLVM_CLANG=$OLLVM_CLANG" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_CLANGXX=$OLLVM_CLANGXX" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_NDK=$OLLVM_NDK_ROOT" >> $GITHUB_ENV
          else
            FALLBACK_URL="${MI_E2EE_OLLVM_FALLBACK_URL}"
            FALLBACK_DIR="build/ollvm/fallback/bin"
            mkdir -p "$FALLBACK_DIR"
            curl -L "$FALLBACK_URL" -o "$FALLBACK_DIR/clang"
            chmod +x "$FALLBACK_DIR/clang"
            printf '%s\n' \
              '#!/usr/bin/env bash' \
              'DIR=$(cd "$(dirname "$0")" && pwd)' \
              'exec "$DIR/clang" --driver-mode=g++ "$@"' \
              > "$FALLBACK_DIR/clang++"
            chmod +x "$FALLBACK_DIR/clang++"
            if ! "$FALLBACK_DIR/clang" --version >/dev/null 2>build/ollvm/fallback/clang_error.log; then
              echo "Fallback OLLVM clang is not runnable on this runner." >&2
              cat build/ollvm/fallback/clang_error.log >&2 || true
              file "$FALLBACK_DIR/clang" >&2 || true
              ldd "$FALLBACK_DIR/clang" >&2 || true
              exit 1
            fi
            OLLVM_CLANG=$(realpath "$FALLBACK_DIR/clang")
            OLLVM_CLANGXX=$(realpath "$FALLBACK_DIR/clang++")
            echo "MI_E2EE_OLLVM_CLANG=$OLLVM_CLANG" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_CLANGXX=$OLLVM_CLANGXX" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_NDK=" >> $GITHUB_ENV
            echo "MI_E2EE_OLLVM_FALLBACK=1" >> $GITHUB_ENV
          fi

      - name: Configure local.properties
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > android/local.properties

      - name: Build Android debug
        run: |
          chmod +x android/gradlew
          cd android
          ./gradlew :app:assembleDebug -PmiE2eeOpaque=false --no-daemon

      - name: Build Android release
        run: |
          chmod +x android/gradlew
          cd android
          OLLVM_ARGS=()
          if [ "${MI_E2EE_ANDROID_OLLVM}" = "1" ] || [ "${MI_E2EE_ANDROID_OLLVM}" = "true" ]; then
            OLLVM_ARGS+=("-PmiE2eeOllvm=true")
            OLLVM_ARGS+=("-PmiE2eeOllvmClang=${MI_E2EE_OLLVM_CLANG}")
            OLLVM_ARGS+=("-PmiE2eeOllvmClangxx=${MI_E2EE_OLLVM_CLANGXX}")
          fi
          ./gradlew :app:assembleRelease -PmiE2eeOpaque=false "${OLLVM_ARGS[@]}" --no-daemon

      - name: Upload Android debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_android_debug
          path: android/app/build/outputs/apk/debug/*.apk

      - name: Upload Android release artifact
        uses: actions/upload-artifact@v4
        with:
          name: mi_e2ee_android_release
          path: android/app/build/outputs/apk/release/*.apk
